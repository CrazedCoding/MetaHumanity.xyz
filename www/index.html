<!DOCTYPE html>
<html>

<head>
    <title>MetaHumanity.xyz</title>
    <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="icon" type="image/x-icon" href="assets/icon/favicon.ico">
    <link rel="stylesheet" href="codemirror/lib/codemirror.css">
    <link rel="stylesheet" href="codemirror/addon/dialog/dialog.css">
    <link rel="stylesheet" href="codemirror/addon/search/matchesonscrollbar.css">
    <link rel="stylesheet" href="codemirror/theme/the-matrix.css">

    <script type="text/javascript" src="codemirror/lib/codemirror.js"></script>
    <script type="text/javascript" src="codemirror/mode/javascript/javascript.js"></script>
    <script type="text/javascript" src="codemirror/mode/clike/clike.js"></script>
    <script type="text/javascript" src="codemirror/mode/xml/xml.js"></script>

    <script type="text/javascript" src="codemirror/addon/display/autorefresh.js"></script>
    <script type="text/javascript" src="codemirror/addon/dialog/dialog.js"></script>
    <script type="text/javascript" src="codemirror/addon/search/searchcursor.js"></script>
    <script type="text/javascript" src="codemirror/addon/search/search.js"></script>
    <script type="text/javascript" src="codemirror/addon/scroll/annotatescrollbar.js"></script>
    <script type="text/javascript" src="codemirror/addon/search/matchesonscrollbar.js"></script>
    <script type="text/javascript" src="codemirror/addon/search/jump-to-line.js"></script>

    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/style.css" />

    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="js/protobuf.js"></script>
</head>

<body>
    <div id="menu" class="topnav">
        <a id="home_button" href="#home">Home</a>
        <a id="browse_button" onclick="state.show_page(pages.BROWSE); ">Browse</a>
        <a id="edit_button" onclick="state.show_page(pages.EDIT); ">Edit</a>
        <a id="create_button" onclick="state.show_page(pages.CREATE); ">Create</a>
        <a id="profile_button" class="logged_in_content" style="display: none"
            onclick="state.show_page(pages.PROFILE);;">Profile</a>
        <a id="login_button" class="logged_out_content" onclick="state.show_page(pages.LOGIN);">Login</a>
        <a id="signup_button" class="logged_out_content" style="display: none"
            onclick="state.show_page(pages.SIGNUP);">Sign Up</a>
        <a id="log_out_button" class="logged_in_content" style="display: none"
            onclick="state.show_page(pages.LOGOUT);">Log Out</a>
        <a href="javascript:void(0);" class="icon" onclick="state.toggle_nav()">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
        </a>
    </div>

    <div class="belownav" onclick="state.collapse_nav();">
    </div>
    <div class="row disconnected_content"
    style="display:none; margin: 0px !important; z-index: 250; position:fixed; text-align:center; border:none !important; height:100%; width:100%;  overflow-y: auto; background-color: rgba(0., 0., 0., 0.);"
    id="processing">
    <div class="col-0 col-sm-0 col-md-1 col-lg-2">
    </div>
    <div class="col-12 col-sm-12 col-md-10 col-lg-8">
        <div style="height: 20%;"></div>
        <h1 style=" padding:5%; text-align:center; color:#f00; font-size: 24px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;"
            class="blink-white">
            <div id="processing_header" style="text-align:center; color:#0f0; font-size: 24px !important;"
                class="blink-white">
                Infinite processing.
            </div>
            <br>
            <label id="processing_message" style="font-size: 14px !important;color: #fff;">
                Don't hold you're breath.
            </label>
            <br>
            <br>
            <div style="text-align: center;">
                <button type="button" class="opt_out btn btn-outline-success mx-auto" style="display: none;"
                    onclick="state.back()">OK</button>
            </div>
        </h1>
    </div>
    <div class="col-0 col-sm-0 col-md-1 col-lg-2">
    </div>
</div>
<div class="row disconnected_content"
    style="display:none; margin: 0px !important; z-index: 300; position:absolute; text-align:center; border:none !important; height:100%; width:100%;  overflow-y: auto; background-color: rgba(0., 0., 0., 0.);"
    id="client_error">
    <div class="col-0 col-sm-0 col-md-1 col-lg-2">
    </div>
    <div class="col-12 col-sm-12 col-md-10 col-lg-8">
        <div style="height: 20%;"></div>
        <h1 style=" padding:5%; text-align:center; color:#f00; font-size: 24px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;"
            id="error_bubble" class="blink-white">
            <div id="client_error_header" style="text-align:center; color:#f00; font-size: 24px !important;"
                class="blink-white">
            </div>
            <br>
            <label id="client_error_message" style="font-size: 14px !important;color: #fff;"></label>
            <br>
            <br>
            <div style="text-align: center;">
                <button type="button" class="btn btn-outline-danger mx-auto" onclick="state.back();">OK</button>
            </div>
        </h1>
    </div>
    <div class="col-0 col-sm-0 col-md-1 col-lg-2">
    </div>
</div>
<div class="row disconnected_content"
    style="display:none; margin: 0px !important; z-index: 400; position:absolute; text-align:center; border:none !important; height:100%; width:100%;  overflow-y: auto; background-color: rgba(0., 0., 0., 0.);"
    id="server_error">
    <div class="col-0 col-sm-0 col-md-1 col-lg-2">
    </div>
    <div class="col-12 col-sm-12 col-md-10 col-lg-8">
        <div style="height: 20%;"></div>
        <h1 style=" padding:5%; text-align:center; color:#f00; font-size: 24px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;"
            id="error_bubble" class="blink-white">
            <div id="server_error_header" style="text-align:center; color:#f00; font-size: 24px !important;"
                class="blink-white">
            </div>
            <br>
            <label id="server_error_message" style="font-size: 14px !important;color: #fff;"></label>
            <br>
            <br>
            <div style="text-align: center;">
                <button type="button" class="btn btn-outline-danger mx-auto" onclick="state.back();">OK</button>
            </div>
        </h1>
    </div>
    <div class="col-0 col-sm-0 col-md-1 col-lg-2">
    </div>
</div>
    <!-- <div fixed id="iframeDiv"
        style="position: fixed; top: 0px; left: 0px; right: 0px; bottom: 0px; height: 100%; width: 100%; z-index: -1;">
        <iframe sandbox="allow-scripts" allow="microphone" style="border: 0; margin: 0px !important;" src="canvas.html"
            id="mainIframe" class="webGLDiv"></iframe> -->

    <script>
        var iframe = null;

        //Protocol Buffer Types
        var Message = null;
        var User = null;
        var Captcha = null;

        const pages = {
            RECONNECT: "#reconnect",
            PROCESSING: "#processing",
            RESET: "#reset",
            POLICY: "#policy",
            LOGOUT: "#logout",
            DELETE_ALGORITHM: "#delete_algorithm",
            REQUEST: "#request",
            CLIENT_ERROR: "#client_error",
            SERVER_ERROR: "#server_error",
            HOME: "#home",
            BROWSE: "#browse",
            EDIT: "#edit",
            CREATE: "#create",
            DELETE_ACCOUNT: "#delete_account",
            PROFILE: "#profile",
            LOGIN: "#login",
            SIGNUP: "#signup",
        }

        function is_message_page(page_name) {
            return page_name == pages.CLIENT_ERROR ||
                page_name == pages.SERVER_ERROR ||
                page_name == pages.PROCESSING;
        }
        function Video() {
            this.data = null;
            this.extension = null;
            this.name = "";
        }

        function GlobalState() {
            this.logged_in = false;
            this.user_name = "";
            this.user_email = ""
            this.user_password = ""
            this.websocket = null;
            this.protocol = null;
            this.last_captcha = null;
            this.current_page_state = null;
            this.local_file = null;
            this.video = new Video();
            this.result = null;
            this.page_history = []
            this.first_connection = true;
            this.page_transitions = [];
            this.deleting_algorithm = false;
            this.deleting_account = false;
            this.pipeline = {
                contexts: [],
                programs: [],
                stages: []
            };
            this.context_codemirrors = [];
            this.program_codemirrors = [];
            this.stage_codemirrors = [];
        }
        var Auth, Image, Video, Sound, Person, Comment, MetaAlgorithm,
            Query, Catalog, Vote, OpenGLDimension, OpenGLUniform, OpenGLContext,
            OpenGLProgram, OpenGLStage, OpenGLPipeline, AlgorithmState,
            Algorithm, Custom, Error, Captcha, Message;

        var default_opengl_dimension, default_algorithm_context, default_algorithm_uniform,
            default_algorithm_program, default_algorithm_stage, default_create_algorithm;

        GlobalState.prototype.post_connect_load = function () {
            this.show_logged_out_content();
        }
        
        GlobalState.prototype.wait_for_proto_and_connect = function () {
            protobuf.load("proto/messages.proto", function (err, root) {
                if (err)
                    throw err;

                // Obtain a message type
                this.protocol = root;
                // Auth = this.protocol.lookupType("messages.Auth");
                // Video = this.protocol.lookupType("messages.Video");
                // Sound = this.protocol.lookupType("messages.Sound");
                // Person = this.protocol.lookupType("messages.Person");
                // Comment = this.protocol.lookupType("messages.Comment");
                // MetaAlgorithm = this.protocol.lookupType("messages.MetaAlgorithm");
                // Query = this.protocol.lookupType("messages.Query");
                // Catalog = this.protocol.lookupType("messages.Catalog");
                // Vote = this.protocol.lookupType("messages.Vote");
                OpenGLDimension = this.protocol.lookupType("messages.OpenGLDimension");
                OpenGLUniform = this.protocol.lookupType("messages.OpenGLUniform");
                // OpenGLContext = this.protocol.lookupType("messages.OpenGLContext");
                // OpenGLProgram = this.protocol.lookupType("messages.OpenGLProgram");
                OpenGLStage = this.protocol.lookupType("messages.OpenGLStage");
                // OpenGLPipeline = this.protocol.lookupType("messages.OpenGLPipeline");
                // AlgorithmState = this.protocol.lookupType("messages.AlgorithmState");
                // Algorithm = this.protocol.lookupType("messages.Algorithm");
                // Custom = this.protocol.lookupType("messages.Custom");
                // Error = this.protocol.lookupType("messages.Error");
                // Captcha = this.protocol.lookupType("messages.Captcha");
                Message = this.protocol.lookupType("messages.Message");

                this.show_page(pages.PROCESSING, "Connecting...", "Please be patient.", false, true);
                this.connect();
            }.bind(this));
        }
        GlobalState.prototype.reconnect = function () {
            this.back(false);
            this.show_page(pages.PROCESSING, "Reconnecting...", "Please be patient.", false, true);
            this.connect();
        }
        GlobalState.prototype.connect = function () {
            this.websocket = new WebSocket("wss://" + window.location.hostname);

            this.websocket.binaryType = "arraybuffer";
            this.websocket.onclose = function (event) {
                this.logged_in = false;
                //$(".connected_content").css("visibility", "hidden");
                this.show_logged_out_content();
                this.page_history = [];
                this.show_page(pages.LOGIN, null, null, null, false);
                this.show_page(pages.RECONNECT, null, null, true, false)
                this.show_page(pages.CLIENT_ERROR, "Connection closed. Code: " + event.code, "If you were logged in, you are now logged out.", true, true);
            }.bind(this)
            this.websocket.onmessage = function (event) {
                try {
                    var decoded = Message.decode(new Uint8Array(event.data));
                    this.handle_message(decoded);
                }
                catch (e) {
                    this.show_page(pages.CLIENT_ERROR, "Error! Could not decode server response", e + "", true);
                }
            }.bind(this);
            this.websocket.onopen = function () {
                /*
                $(".disconnected_content").css("visibility", "visible");
                
                if (this.websocket && this.websocket.readyState == WebSocket.OPEN)
                    $(".connected_content").css("visibility", "visible");
                else
                    $(".connected_content").css("visibility", "hidden");
                */
                if (!this.first_connection)
                    this.back();
                this.post_connect_load()
            }.bind(this);

            //$(".disconnected_content").css("visibility", "visible");
        }

        GlobalState.prototype.send = function (encoded, request_updates = false) {
            this.websocket.send(encoded.length);

            if (request_updates)
                this.websocket.send(1);
            else
                this.websocket.send(0);
            var fragment_size = 1024 * 512;
            for (var i = 0; i < encoded.length; i += fragment_size) {
                var start = i;
                var end = i + fragment_size;
                this.websocket.send(encoded.subarray(start, end));
            }
        }
        GlobalState.prototype.refresh_captchas = function () {
            if (this.websocket && this.websocket.readyState == WebSocket.OPEN)
                this.send(Message.encode({ type: Message.Type.CAPTCHA }).finish());
        }

        GlobalState.prototype.handle_message = function (proto) {
            console.log(proto);

            if (proto.type == Message.Type.LOGIN) {
                this.user_name = proto.auth.user;
                this.user_email = proto.auth.email;
                //this.user_password = proto.auth.password;
                this.hash = proto.auth.hash;
                this.logged_in = true;
                this.show_page(pages.HOME);
            }
            if (proto.type == Message.Type.AUTH) {
                this.hash = proto.auth.hash;
            }
            else if (proto.type == Message.Type.SET_PASSWORD) {
                this.show_page(pages.PROCESSING, proto.message, proto.details, true, true);
            }
            else if (proto.type == Message.Type.HALT) {
                this.show_page(pages.PROCESSING, proto.message, proto.details, false, true);
            }
            else if (proto.type == Message.Type.PROGRESS) {
                if (this.deleting_algorithm) {
                    this.deleting_algorithm = false;
                    return;
                }
                this.show_page(pages.PROCESSING, proto.message, proto.details, true, true);
            }
            else if (proto.type == Message.Type.DELETE_ALGORITHM) {
                if (this.deleting_algorithm) {
                    this.deleting_algorithm = false;
                }
                this.back(false);
                this.show_page(pages.PROCESSING, proto.message, proto.details, true, true);
            }
            else if (proto.type == Message.Type.ERROR) {
                this.show_page(pages.SERVER_ERROR, proto.message, proto.details, true, true);
            }
            else if (proto.type == Message.Type.CAPTCHA) {


                var base_64_encoded = btoa(String.fromCharCode.apply(null, proto.captcha.image));

                this.unfiltered_captcha_image = document.createElement('img');
                this.unfiltered_captcha_image.onload = (function () {
                    var canvas = document.createElement('canvas');
                    canvas.width = this.unfiltered_captcha_image.width;
                    canvas.height = this.unfiltered_captcha_image.height;

                    var ctx = canvas.getContext("2d");

                    ctx.drawImage(this.unfiltered_captcha_image, 0, 0);
                    ctx.globalCompositeOperation = 'difference';
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    var image_data = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    var real_max = 0;
                    var real_min = 1E32;
                    for (var i = 0; i < image_data.data.length; i += 4) {
                        var max = Math.max(image_data.data[i], Math.max(image_data.data[i + 1], image_data.data[i + 2]));
                        var min = Math.min(image_data.data[i], Math.min(image_data.data[i + 1], image_data.data[i + 2]));
                        if (max < 32) {
                            image_data.data[i + 3] = 0; // alpha
                        }
                        else
                            real_min = Math.min(real_min, min);
                        real_max = Math.max(real_max, max);
                    }

                    for (var i = 0; i < image_data.data.length; i += 4) {
                        image_data.data[i] = (image_data.data[i] - real_min) / (real_max - real_min) * 256.;
                        image_data.data[i + 1] = (image_data.data[i + 1] - real_min) / (real_max - real_min) * 256.;
                        image_data.data[i + 2] = (image_data.data[i + 2] - real_min) / (real_max - real_min) * 256.;
                    }

                    ctx.putImageData(image_data, 0, 0);
                    var new_url = canvas.toDataURL();

                    $('#signup_captcha').attr('src', new_url);
                    $('#login_captcha').attr('src', new_url);
                    $('#reset_captcha').attr('src', new_url);
                    $('#request_captcha').attr('src', new_url);
                    $('#edit_captcha').attr('src', new_url);
                    $('#query_captcha').attr('src', new_url);
                    $('#delete_account_captcha').attr('src', new_url);

                    $('#signup_captcha_input').val("");
                    $('#login_captcha_input').val("");
                    $('#reset_captcha_input').val("");
                    $('#request_captcha_input').val("");
                    $('#edit_captcha_input').val("");
                    $('#query_captcha_input').val("");
                    $('#delete_account_captcha_input').val("");
                }).bind(this);
                this.unfiltered_captcha_image.src = `data:image/png;base64,${base_64_encoded}`

                this.last_captcha = proto.captcha;
            }
        }

        GlobalState.prototype.show_logged_out_content = function (new_page) {
            $.each($(".logged_in_content"), function () {
                if ($(this).is(":visible") && ($(new_page).has($(this)).length > 0 || $(this).parents().has("#menu").length > 0))
                    $(this).fadeOut(1000);
            });
            $.each($(".logged_out_content"), function () {
                if ($(this).is(":hidden") && ($(new_page).has($(this)).length > 0 || ($(this).parents().has("#menu").length > 0))) {
                    if ($($(this).parents()[0]).hasClass("topnav"))
                        $(this).attr("style", "");
                    else
                        $(this).fadeIn(1000).css("display", "block");
                }
            });
        }

        GlobalState.prototype.show_logged_in_content = function (new_page) {
            $.each($(".logged_in_content"), function () {
                //if($(this).is(":hidden") && 
                if (($(new_page).has($(this)).length > 0 || ($(this).parents().has("#menu").length > 0))) {
                    if ($($(this).parents()[0]).hasClass("topnav"))
                        $(this).attr("style", "");
                    else
                        $(this).fadeIn(1000).css("display", "block");
                }
            });
            $.each($(".logged_out_content"), function () {
                //if($(this).is(":visible") && 
                if (($(new_page).has($(this)).length > 0 || $(this).parents().has("#menu").length > 0))
                    $(this).fadeOut(1000);
            });
        }


        GlobalState.prototype.refresh_content = function (new_page) {
                switch (page) {
                    case pages.RECONNECT:
                        $("#menu").fadeOut(1000);
                        break;
                    case pages.PROCESSING:
                        $("#menu").fadeOut(1000);
                        $("#processing_header").text(message);
                        $("#processing_message").text(subtext);

                        if (opt_out)
                            $(".opt_out").fadeIn(1000);
                        else
                            $(".opt_out").fadeOut(1000);
                        break;
                    case pages.RESET:
                        this.refresh_captchas();
                        $("#menu").fadeOut(1000);
                        break;
                    case pages.POLICY:
                        $("#menu").fadeOut(1000);
                        break;
                    case pages.REQUEST:
                        this.refresh_captchas();
                        $("#menu").fadeOut(1000);
                        break;
                    case pages.CLIENT_ERROR:
                        $("#menu").fadeOut(1000);
                        $("#client_error_header").text(message);
                        $("#client_error_message").text(subtext);

                        if (opt_out)
                            $(".opt_out").fadeIn(1000);
                        else
                            $(".opt_out").fadeOut(1000);
                        break;
                    case pages.SERVER_ERROR:
                        $("#menu").fadeOut(1000);
                        $("#server_error_header").text(message);
                        $("#server_error_message").text(subtext);

                        if (opt_out)
                            $(".opt_out").fadeIn(1000);
                        else
                            $(".opt_out").fadeOut(1000);
                        break;
                    case pages.HOME:
                        $("#menu").fadeIn(1000);

                        $("#home_button").addClass("active")
                        $("#browse_button").removeClass("active")
                        $("#edit_button").removeClass("active")
                        $("#create_button").removeClass("active")
                        $("#profile_button").removeClass("active")
                        $("#login_button").removeClass("active")
                        $("#signup_button").removeClass("active")
                        break;
                    case pages.BROWSE:
                        $("#browse").fadeIn(1000);
                        $("#menu").fadeIn(1000);

                        $("#home_button").removeClass("active")
                        $("#browse_button").addClass("active")
                        $("#edit_button").removeClass("active")
                        $("#create_button").removeClass("active")
                        $("#profile_button").removeClass("active")
                        $("#login_button").removeClass("active")
                        $("#signup_button").removeClass("active")
                        break;
                    case pages.EDIT:
                        this.refresh_captchas();
                        $("#menu").fadeIn(1000);

                        $("#home_button").removeClass("active")
                        $("#browse_button").removeClass("active")
                        $("#edit_button").addClass("active")
                        $("#create_button").removeClass("active")
                        $("#profile_button").removeClass("active")
                        $("#login_button").removeClass("active")
                        $("#signup_button").removeClass("active")
                        break;
                    case pages.CREATE:
                        $("#create").fadeIn(1000);
                        $("#menu").fadeIn(1000);

                        $("#home_button").removeClass("active")
                        $("#browse_button").removeClass("active")
                        $("#edit_button").removeClass("active")
                        $("#create_button").addClass("active")
                        $("#profile_button").removeClass("active")
                        $("#login_button").removeClass("active")
                        $("#signup_button").removeClass("active")
                        break;
                    case pages.DELETE_ACCOUNT:
                        this.refresh_captchas();
                        $("#menu").fadeOut(1000);
                        break;
                    case pages.PROFILE:
                        $("#menu").fadeIn(1000);

                        $("#home_button").removeClass("active")
                        $("#browse_button").removeClass("active")
                        $("#edit_button").removeClass("active")
                        $("#create_button").removeClass("active")
                        $("#profile_button").addClass("active")
                        $("#login_button").removeClass("active")
                        $("#signup_button").removeClass("active")
                        break;
                    case pages.LOGIN:
                        this.refresh_captchas();
                        $("#menu").fadeIn(1000);

                        $("#home_button").removeClass("active")
                        $("#browse_button").removeClass("active")
                        $("#edit_button").removeClass("active")
                        $("#create_button").removeClass("active")
                        $("#profile_button").removeClass("active")
                        $("#login_button").addClass("active")
                        $("#signup_button").removeClass("active")
                        break;
                    case pages.SIGNUP:
                        this.refresh_captchas();
                        $("#menu").fadeIn(250);

                        $("#home_button").removeClass("active")
                        $("#browse_button").removeClass("active")
                        $("#edit_button").removeClass("active")
                        $("#create_button").removeClass("active")
                        $("#profile_button").removeClass("active")
                        $("#login_button").removeClass("active")
                        $("#signup_button").addClass("active")
                        break;
                }
                if (this.logged_in)
                    this.show_logged_in_content(page)
                else
                    this.show_logged_out_content(page);
            }

        GlobalState.prototype.apply_page_change = function (change_function) {
            var page = this.current_page;
            var message = "";
            switch (page) {
                case pages.RECONNECT:
                    message = "Reconnect";
                    break;
                case pages.PROCESSING:
                    message = "Processing";
                    break;
                case pages.RESET:
                    message = "Password Reset";
                    break;
                case pages.POLICY:
                    message = "Site Policies";
                    break;
                case pages.REQUEST:
                    message = "Request Password Reset";
                    break;
                case pages.CLIENT_ERROR:
                    message = "Client Error";
                    break;
                case pages.SERVER_ERROR:
                    message = "Server Error";
                    break;
                case pages.HOME:
                    message = "General Information";
                    break;
                case pages.BROWSE:
                    message = "Browse Algorithms";
                    break;
                case pages.EDIT:
                    message = "Edit Algorithm";
                    break;
                case pages.CREATE:
                    message = "Create Algorithm";
                    break;
                case pages.CREATE_QUERY:
                    message = "Create Visual Query";
                    break;
                case pages.DELETE_ACCOUNT:
                    message = "Delete Account";
                    break;
                case pages.PROFILE:
                    message = "Profile";
                    break;
                case pages.LOGIN:
                    message = "Log In";
                    break;
                case pages.SIGNUP:
                    message = "Sign Up";
                    break;
            }
            change_function(this.current_page_state, message, page);
        }

        GlobalState.prototype.coming_soon = function () {
            this.show_page(pages.PROCESSING, "This feature is coming soon!", "Please check again at a later date.", true, true);
        }

        GlobalState.prototype.get_ui_stages = function () {
            var ui_stages = [];
            for (var i = 0; i < this.pipeline.stages.length; i++) {
                var stage = this.pipeline.stages[i];
                var stage_identifier = stage.identifier;
                console.log(stage_identifier);
                var ui_stage = JSON.parse(JSON.stringify(stage));

                ui_stage.name = $("#" + stage_identifier + '_name').val();

                ui_stage.mesh_indices_eval = this.stage_codemirrors[i][0].getValue()
                ui_stage.mesh_vertices_eval = this.stage_codemirrors[i][1].getValue()

                ui_stages.push(ui_stage);
            }
            return ui_stages;
        }

        GlobalState.prototype.toggle_nav = function () {
            var x = document.getElementById("menu");
            if (x.className === "topnav") {
                x.className += " responsive";
            } else {
                x.className = "topnav";
            }
        }
        GlobalState.prototype.collapse_nav = function () {
            var x = document.getElementById("menu");
            x.className = "topnav";
        }
        GlobalState.prototype.show_page = function (new_page) {
            this.collapse_nav();
            console.log("SHOWING PAGE: "+new_page);

            if(new_page == pages.PROCESSING || 
                new_page == pages.CLIENT_ERROR ||
                new_page == pages.SERVER_ERROR)
            {
                $(function () {
                    $(new_page).popover({
                    container: 'body'
                    })
                })
            }
            else
                window.location.hash = new_page;
        }
        var on_resources_loaded = function () {
            console.log($)//Show me the money
            if (typeof $ == 'undefined' ||
                typeof $('[data-toggle="tooltip"]') == 'undefined' ||
                typeof $('[data-toggle="tooltip"]').tooltip == 'undefined' ||
                !protobuf)
                window.setTimeout(on_resources_loaded, 1000);
            else {
                $('[data-toggle="tooltip"]').tooltip();
                state.wait_for_proto_and_connect()
            }
        }

        GlobalState.prototype.hand_navigation = function () {
            var page = (window.location.hash ? window.location.hash.substring(1) : "home") + '.html';
            console.log("FETCH PAGE: "+page);
            $('.belownav').fadeOut(1000, ()=>{
                $.get(page, function (response) {
                    $('.belownav').html(response).fadeIn(1000);
                    this.refresh_captchas();
                }.bind(this))
            })
        }
        state = new GlobalState();
        window.onload = function () {
            state.hand_navigation();
        }
        
        $(window).on('hashchange', function () {
            state.hand_navigation();
        });
    </script>
</body>

</html>