<!DOCTYPE html>
<html>

<head>
    <title>MetaHumanity.xyz</title>
    <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="icon" type="image/x-icon" href="assets/icon/favicon.ico">
    <link rel="stylesheet" href="codemirror/lib/codemirror.css">
    <link rel="stylesheet" href="codemirror/addon/dialog/dialog.css">
    <link rel="stylesheet" href="codemirror/addon/search/matchesonscrollbar.css">
    <link rel="stylesheet" href="codemirror/theme/the-matrix.css">

    <script type="text/javascript" src="codemirror/lib/codemirror.js"></script>
    <script type="text/javascript" src="codemirror/mode/javascript/javascript.js"></script>
    <script type="text/javascript" src="codemirror/mode/clike/clike.js"></script>
    <script type="text/javascript" src="codemirror/mode/xml/xml.js"></script>

    <script type="text/javascript" src="codemirror/addon/display/autorefresh.js"></script>
    <script type="text/javascript" src="codemirror/addon/dialog/dialog.js"></script>
    <script type="text/javascript" src="codemirror/addon/search/searchcursor.js"></script>
    <script type="text/javascript" src="codemirror/addon/search/search.js"></script>
    <script type="text/javascript" src="codemirror/addon/scroll/annotatescrollbar.js"></script>
    <script type="text/javascript" src="codemirror/addon/search/matchesonscrollbar.js"></script>
    <script type="text/javascript" src="codemirror/addon/search/jump-to-line.js"></script>

    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/style.css" />

    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="js/protobuf.js"></script>

</head>

<body>
    <div class="row connected_content"
        style="display: none; margin: 0px !important; z-index: 225; position:absolute; text-align:center; border:none !important; height:100%; width:100%;  overflow-y: auto; background-color: rgba(0.0, 0.0, 0.0, 0.0);"
        id="policy">
        <div class="col-0 col-sm-0 col-md-1 col-lg-2">
        </div>
        <div class="col-12 col-sm-12 col-md-10 col-lg-8">
            <br>
            <h1
                style="text-align:left; padding:5%; color:#fff; font-size: 14px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">
                Privacy Policy:
                <br>
                <br>
                1. Collected Information
                <br>
                <br>
                We collect information such your name, email, and password.
                <br>
                <br>
                We will not issue out your email or password to any third party.
                <br>
                <br>
                We may however use your email to contact you with regards to anything we deem fit. We may also publicly
                display your name.
                <br>
                <br>
                We also collect data related to the algorithms you create, edit, and fork on our site.
                <br>
                <br>
                For each algorithm (and associated data) you create/edit/fork, we may display this algorithm (or
                it's associated data) to any third party.
                <br>
                <br>
                2. Cookie Policy
                <br>
                <br>
                Our website does not use cookies to track any of your online events (which is why you have to log in
                every time you move to a new window).
                <br>
                <br>
                <br>
                <div style="text-align: center;">
                    <button type="button" class="btn btn-outline-success mx-auto" onclick="state.back();">Ok</button>
                </div>
            </h1>
        </div>
        <div class="col-0 col-sm-0 col-md-1 col-lg-2">
        </div>
    </div>

    <div class="row connected_content"
        style="display: none; margin: 0px !important; z-index: 230; position:absolute; text-align:center; border:none !important; height:100%; width:100%;  overflow-y: auto; background-color: rgba(0., 0., 0., 0.);"
        id="logout">
        <div class="col-0 col-sm-0 col-md-1 col-lg-2">
        </div>
        <div class="col-12 col-sm-12 col-md-10 col-lg-8">
            <div style="height: 10%;"></div>
            <h1 style=" padding:5%; text-align:center; color:#f00; font-size: 24px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;"
                class="blink-white">
                <div style="text-align:center; color:#f00; font-size: 24px !important;" class="blink-white">
                    This action will log you off by resetting the connection to the server!
                </div>
                <br>
                <label style="font-size: 14px !important;color: #fff;">
                    Click OK to continue, and cancel to return.
                </label>
                <br>
                <br>
                <div style="text-align: center;">
                    <button type="button" class="btn btn-outline-success mx-auto"
                        onclick="state.back();">Cancel</button>
                    <button type="button" class="btn btn-outline-danger mx-auto" onclick="state.logout()">OK</button>
                </div>
            </h1>
        </div>
        <div class="col-0 col-sm-0 col-md-1 col-lg-2">
        </div>
    </div>
    <div class="row connected_content"
        style="display: none; margin: 0px !important; z-index: 230; position:absolute; text-align:center; border:none !important; height:100%; width:100%;  overflow-y: auto; background-color: rgba(0., 0., 0., 0.);"
        id="delete_algorithm">
        <div class="col-0 col-sm-0 col-md-1 col-lg-2">
        </div>
        <div class="col-12 col-sm-12 col-md-10 col-lg-8">
            <div style="height: 10%;"></div>
            <h1 style=" padding:5%; text-align:center; color:#f00; font-size: 24px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;"
                class="blink-white">
                <div style="text-align:center; color:#f00; font-size: 24px !important;" class="blink-white">
                    This action is permanent and irreversable. Are you sure you want to delete this algorithm?
                </div>
                <br>
                <label style="font-size: 14px !important;color: #fff;">
                    Click OK to continue, and cancel to return.
                </label>
                <br>
                <br>
                <div style="text-align: center;">
                    <button type="button" class="btn btn-outline-success mx-auto"
                        onclick="state.back();">Cancel</button>
                    <button type="button" class="btn btn-outline-danger mx-auto"
                        onclick="state.end_algorithm_delete();">Delete Video</button>
                </div>
            </h1>
        </div>
        <div class="col-0 col-sm-0 col-md-1 col-lg-2">
        </div>
    </div>
    <div class="row connected_content"
        style="display: none; margin: 0px !important; z-index: 200; position:absolute; text-align:center; border:none !important; height:100%; width:100%;  overflow-y: auto; background-color: rgba(.666,.666,.666,0.0);"
        id="request">
        <div class="col-0 col-sm-0 col-md-1 col-lg-2">
        </div>
        <div class="col-12 col-sm-12 col-md-10 col-lg-8">
            <br>
            <h1 style="text-align:center; color:#0f0; font-size: 14px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;"
                class="blink-white">
                <br>
                Request a password reset link for your account below:
                <br>
                <br>
            </h1>

            <h1
                style="text-align:center; color:#fff; font-size: 14px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">
                <br>
                By requesting a reset link for your password you agree to our privacy policy:
                <br>
                <br>

                <div style="text-align: center;">
                    <button type="button" class="btn btn-outline-primary mx-auto"
                        onclick="state.show_page(pages.POLICY);">View
                        Privacy Policy</button>
                </div>
                <br>




                <div
                    style="display: inline-block; text-align:center; color:#fff; font-size: 14px !important; width:50%;">
                    Name or Email
                </div>
                <input type="text" style="display: inline-block; font-size: 14px !important; width:40%;"
                    class="form-control" id="request_password_reset" placeholder="Name or Email">


                <br>
                <br>

                <div style="display: inline-block; width:50%">
                    <img style="display: inline-block; text-align:center; color:#fff; font-size: 14px !important; height:50%;"
                        id="request_captcha">
                </div>
                <input type="text" style="display: inline-block; font-size: 14px !important; width:40%;"
                    class="form-control" id="request_captcha_input" placeholder="Captcha">
                <br>
                <br>


                <div style="text-align: center;">
                    <button type="button" class="btn btn-outline-success mx-auto" onclick="state.send_request()">Send
                        Email</button>
                    <button type="button" class="btn btn-outline-warning mx-auto"
                        onclick="state.back();">Cancel</button>
                </div>
                <br>
            </h1>
        </div>
        <div class="col-0 col-sm-0 col-md-1 col-lg-2">
        </div>
    </div>

    <div class="row connected_content"
        style="display: none; margin: 0px !important; z-index: 20; position:absolute; text-align:center; border:none !important; height:100%; width:100%;  overflow-y: auto; background-color: rgba(0,0,0,.75);"
        id="reset">
        <div style="height: 7.5%;"></div>
        <div class="col-0 col-sm-0 col-md-1 col-lg-2">
        </div>
        <div class="col-12 col-sm-12 col-md-10 col-lg-8">
            <br>
            <h1 style="text-align:center; color:#0f0; font-size: 14px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;"
                class="blink-white">
                <br>
                Create or change the password for your account below:
                <br>
                <br>
            </h1>

            <h1
                style="text-align:center; color:#fff; font-size: 14px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">
                <br>
                By (re)setting your password you agree to our privacy policy:
                <br>
                <br>

                <div style="text-align: center;">
                    <button type="button" class="btn btn-outline-primary mx-auto"
                        onclick="state.show_page(pages.POLICY);">View
                        Privacy Policy</button>
                </div>
                <br>

                A valid password has at least one number, at least one letter, and at least six characters.
                <br>
                <br>
                <div
                    style="display: inline-block; text-align:center; color:#fff; font-size: 14px !important; width:50%;">
                    Password
                </div>
                <input type="password" style="display: inline-block; font-size: 14px !important; width:40%;"
                    class="form-control" id="reset_password" placeholder="Password">
                <br>
                <br>
                <div
                    style="display: inline-block; text-align:center; color:#fff; font-size: 14px !important; width:50%;">
                    Re-type Password
                </div>
                <input type="password" style="display: inline-block; font-size: 14px !important; width:40%;"
                    class="form-control" id="reset_retype" placeholder="Password">
                <br>
                <br>
                <div style="display: inline-block; text-align:center; min-width:50%; max-height:50% !important;">
                    <img style="display: inline-block; text-align:center; color:#fff; font-size: 14px !important; max-width:50%;"
                        id="reset_captcha">
                </div>
                <input type="text" style="display: inline-block; font-size: 14px !important; width:40%;"
                    class="form-control" id="reset_captcha_input" placeholder="Captcha">
                <br>
                <br>

                <button type="button" class="btn btn-outline-success mx-auto" onclick="state.set_password()">Set
                    Password</button>
                <br>
                <br>
            </h1>
            </table>

        </div>
        <div class="col-0 col-sm-0 col-md-1 col-lg-2">
        </div>
    </div>

    <div class="row disconnected_content"
        style="display: none; margin: 0px !important; z-index: 250; position:fixed; text-align:center; border:none !important; height:100%; width:100%;  overflow-y: auto; background-color: rgba(0., 0., 0., 0.);"
        id="processing">
        <div class="col-0 col-sm-0 col-md-1 col-lg-2">
        </div>
        <div class="col-12 col-sm-12 col-md-10 col-lg-8">
            <div style="height: 20%;"></div>
            <h1 style=" padding:5%; text-align:center; color:#f00; font-size: 24px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;"
                class="blink-white">
                <div id="processing_header" style="text-align:center; color:#0f0; font-size: 24px !important;"
                    class="blink-white">
                    Infinite processing.
                </div>
                <br>
                <label id="processing_message" style="font-size: 14px !important;color: #fff;">
                    Don't hold you're breath.
                </label>
                <br>
                <br>
                <div style="text-align: center;">
                    <button type="button" class="opt_out btn btn-outline-success mx-auto" style="display: none;"
                        onclick="state.back()">OK</button>
                </div>
            </h1>
        </div>
        <div class="col-0 col-sm-0 col-md-1 col-lg-2">
        </div>
    </div>
    <div class="row disconnected_content"
        style="display: none; margin: 0px !important; z-index: 225; position:absolute; text-align:center; border:none !important; height:100%; width:100%;  overflow-y: auto; background-color: rgba(0., 0., 0., 0.);"
        id="reconnect">
        <div class="col-0 col-sm-0 col-md-1 col-lg-2">
        </div>
        <div class="col-12 col-sm-12 col-md-10 col-lg-8">
            <div style="height: 20%;"></div>
            <h1 style=" padding:5%; text-align:center; color:#f00; font-size: 24px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;"
                class="blink-white">
                <div style="text-align:center; color:#f00; font-size: 24px !important;" class="blink-white">
                    There is no connection to the server.
                </div>
                <br>
                <label style="font-size: 14px !important;color: #fff;">
                    Click "Reconnect" to reconnect.
                </label>
                <br>
                <br>
                <div style="text-align: center;">
                    <button type="button" class="btn btn-outline-success mx-auto"
                        onclick="state.reconnect()">Reconnect</button>
                </div>
            </h1>
        </div>
        <div class="col-0 col-sm-0 col-md-1 col-lg-2">
        </div>
    </div>
    <div class="row disconnected_content"
        style="display: none; margin: 0px !important; z-index: 300; position:absolute; text-align:center; border:none !important; height:100%; width:100%;  overflow-y: auto; background-color: rgba(0., 0., 0., 0.);"
        id="client_error">
        <div class="col-0 col-sm-0 col-md-1 col-lg-2">
        </div>
        <div class="col-12 col-sm-12 col-md-10 col-lg-8">
            <div style="height: 20%;"></div>
            <h1 style=" padding:5%; text-align:center; color:#f00; font-size: 24px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;"
                id="error_bubble" class="blink-white">
                <div id="client_error_header" style="text-align:center; color:#f00; font-size: 24px !important;"
                    class="blink-white">
                </div>
                <br>
                <label id="client_error_message" style="font-size: 14px !important;color: #fff;"></label>
                <br>
                <br>
                <div style="text-align: center;">
                    <button type="button" class="btn btn-outline-danger mx-auto" onclick="state.back();">OK</button>
                </div>
            </h1>

        </div>
        <div class="col-0 col-sm-0 col-md-1 col-lg-2">
        </div>
    </div>
    <div class="row disconnected_content"
        style="display: none; margin: 0px !important; z-index: 400; position:absolute; text-align:center; border:none !important; height:100%; width:100%;  overflow-y: auto; background-color: rgba(0., 0., 0., 0.);"
        id="server_error">
        <div class="col-0 col-sm-0 col-md-1 col-lg-2">
        </div>
        <div class="col-12 col-sm-12 col-md-10 col-lg-8">
            <div style="height: 20%;"></div>
            <h1 style=" padding:5%; text-align:center; color:#f00; font-size: 24px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;"
                id="error_bubble" class="blink-white">
                <div id="server_error_header" style="text-align:center; color:#f00; font-size: 24px !important;"
                    class="blink-white">
                </div>
                <br>
                <label id="server_error_message" style="font-size: 14px !important;color: #fff;"></label>
                <br>
                <br>
                <div style="text-align: center;">
                    <button type="button" class="btn btn-outline-danger mx-auto" onclick="state.back();">OK</button>
                </div>
            </h1>

        </div>
        <div class="col-0 col-sm-0 col-md-1 col-lg-2">
        </div>
    </div>
    <div class="connected_content fixed"
        style="text-align:center; display: none; position: relative;; z-index:5; left:0px; top:0px; width:100%; height:auto;"
        id="menu">
        <br>
        <button type="button" style=" background-color: rgba(0,0,0,.75);" class="btn btn-outline-success mx-auto"
            onclick="state.show_page(pages.HOME); ">Home</button>
        <button type="button" style=" background-color: rgba(0,0,0,.75);" class="btn btn-outline-success mx-auto"
            onclick="state.show_page(pages.BROWSE); ">Browse</button>
        <button type="button" style=" background-color: rgba(0,0,0,.75);" class="btn btn-outline-success mx-auto"
            onclick="state.show_page(pages.EDIT); ">Edit</button>
        <button type="button" style=" background-color: rgba(0,0,0,.75);" class="btn btn-outline-success mx-auto"
            onclick="state.show_page(pages.CREATE); ">Create</button>
        <button id="menu_profile_button" style=" background-color: rgba(0,0,0,.75);" type="button"
            class="logged_in_content btn btn-outline-success mx-auto"
            onclick="state.show_page(pages.PROFILE);;">Profile</button>
        <button id="menu_login_button" style=" background-color: rgba(0,0,0,.75);" type="button"
            class="logged_out_content btn btn-outline-success mx-auto"
            onclick="state.show_page(pages.LOGIN);">Login</button>
        <button id="menu_signup_button" style=" background-color: rgba(0,0,0,.75);" type="button"
            class="logged_out_content btn btn-outline-success mx-auto" onclick="state.show_page(pages.SIGNUP);">Sign
            Up</button>
        <button id="menu_logout_button" style=" background-color: rgba(0,0,0,.75);" type="button"
            class="logged_in_content btn btn-outline-danger mx-auto" onclick="state.show_page(pages.LOGOUT);">Log
            Out</button>
    </div>

    <div style="display:block; position:relative; left:0px; top:0px; width:100%; height:100%;">
        <div class="row connected_content" id="home"
            style="display: none; position:absolute; left:0px; top:0px; width:100%; height:100%;">
            <div class="col-0 col-sm-0 col-md-1 col-lg-2">
            </div>
            <div class="col-12 col-sm-12 col-md-10 col-lg-8">
                <h1
                    style="padding: 14px; text-align:center; color:#fff; font-size: 14px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">
                    Welcome!
                    <br>
                </h1>
                <br>
                <h1 class="logged_out_content"
                    style="padding: 14px; text-align:left; color:#fff; font-size: 14px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">
                    For more information, use one of the three option buttons below:
                    <br>
                    <br>

                    <div style="text-align: center;">
                        <button type="button" class="btn btn-outline-success mx-auto"
                            onclick="state.show_page(pages.LOGIN);">Login</button>
                        <button type="button" class="btn btn-outline-success mx-auto"
                            onclick="state.show_page(pages.SIGNUP);">Sign
                            Up</button>
                        <button type="button" class="btn btn-outline-primary mx-auto"
                            onclick="state.show_page(pages.POLICY);">View
                            Privacy Policy</button>
                    </div>
                </h1>
                <h1 class="logged_in_content"
                    style="padding: 14px; text-align:left; color:#fff; font-size: 14px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">
                    You have successfully logged in! To continue, use one of the options below:
                    <br>
                    <br>

                    <div style="text-align: center;">
                        <button type="button" class="btn btn-outline-primary mx-auto"
                            onclick="state.show_page(pages.POLICY);">View
                            Privacy Policy</button>
                        <button type="button" style=" background-color: rgba(0,0,0,.75);"
                            class="btn btn-outline-success mx-auto"
                            onclick="state.show_page(pages.BROWSE); ">Browse</button>
                        <button type="button" style=" background-color: rgba(0,0,0,.75);"
                            class="btn btn-outline-success mx-auto"
                            onclick="state.show_page(pages.EDIT); ">Edit</button>
                        <button type="button" style=" background-color: rgba(0,0,0,.75);"
                            class="btn btn-outline-success mx-auto"
                            onclick="state.show_page(pages.CREATE); ">Create</button>
                        <button type="button" class="btn btn-outline-success mx-auto"
                            onclick="state.show_page(pages.PROFILE);">Profile</button>
                        <button type="button" class="btn btn-outline-danger mx-auto"
                            onclick="state.show_page(pages.LOGOUT);">Log
                            Out</button>
                    </div>
                </h1>
            </div>
            <div class="col-0 col-sm-0 col-md-1 col-lg-2">
            </div>
        </div>

        <div class="row connected_content" id="edit"
            style="display: none; position:absolute; left:0px; top:0px; width:100%; height:100%;">
            <div class="col-0 col-sm-0 col-md-1 col-lg-2">
            </div>
            <div class="col-12 col-sm-12 col-md-10 col-lg-8" style="text-align: center;">

                <h1 class="read_only"
                    style="padding: 14px; text-align:center; color:#fff; font-size: 14px !important; width:max-content; display: inline-block; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">
                    <a>Algorithm Information</a>
                </h1>
                <h1 onclick="profileClicked(algorithm.owner)" class="read_only"
                    style="text-align:center; padding-top: 14px; padding-bottom: 14px; color:#fff; font-size: 14px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">
                    <div class="row">
                        <div class="col-12 col-sm-12 col-md-6 col-lg-6">
                            <a style="color:#FFF!important; ">Preview Image:</a>&nbsp;
                        </div>
                        <div class="col-12 col-sm-12 col-md-6 col-lg-6">
                            <p id="algorithm_thumbnail">
                                <img src="{{((algorithm.thumbnail && algorithm.thumbnail.url) ? algorithm.thumbnail.url : defaultImage)}}"
                                    style="height:100% !important; max-height:128px !important; border: 2px solid #fff !important;" />
                            </p>
                        </div>
                    </div>
                    <br>
                    <div class="row">
                        <div class="col-12 col-sm-12 col-md-6 col-lg-6">
                            <a style="color:#FFF!important; ">Title:</a>&nbsp;
                        </div>
                        <div class="col-12 col-sm-12 col-md-6 col-lg-6">
                            <p id="algorithm_name">{{algorithm.name}}</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 col-sm-12 col-md-6 col-lg-6">
                            <a style="color:#FFF!important; ">Author:</a>&nbsp;
                        </div>
                        <div class="col-12 col-sm-12 col-md-6 col-lg-6">
                            <p id="algorithm_author">{{algorithm.owner.name}}
                            </p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 col-sm-12 col-md-6 col-lg-6">
                            <a style="color:#FFF!important; ">Created:</a>&nbsp;
                        </div>
                        <div class="col-12 col-sm-12 col-md-6 col-lg-6">
                            <p id="algorithm_created">{{getCreated()}}</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 col-sm-12 col-md-6 col-lg-6">
                            <a style="color:#FFF!important; ">Edited:</a>&nbsp;
                        </div>
                        <div class="col-12 col-sm-12 col-md-6 col-lg-6">
                            <p id="algorithm_edited">{{getEdited()}}</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 col-sm-12 col-md-6 col-lg-6">
                            <a style="color:#FFF!important; ">Views:</a>&nbsp;
                        </div>
                        <div class="col-12 col-sm-12 col-md-6 col-lg-6">
                            <p id="algorithm_views">{{algorithm.views}}</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 col-sm-12 col-md-6 col-lg-6">
                            <a style="color:#FFF!important; ">Votes:</a>&nbsp;
                        </div>
                        <div class="col-12 col-sm-12 col-md-6 col-lg-6">
                            <p id="algorithm_vote_total">{{voteTally()}}</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 col-sm-12 col-md-6 col-lg-6">
                            <a style="color:#FFF!important; ">Comments:</a>&nbsp;
                        </div>
                        <div class="col-12 col-sm-12 col-md-6 col-lg-6">
                            <p id="algorithm_comment_count">
                                {{algorithm.comments.length}}</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 col-sm-12 col-md-6 col-lg-6">
                            <a style="color:#FFF!important; ">Description:</a>&nbsp;
                        </div>
                        <div class="col-12 col-sm-12 col-md-6 col-lg-6">
                            <p id="algorithm_description">
                                {{algorithm.description}}
                            </p>
                        </div>
                    </div>
                </h1>

                <h1 class="editable"
                    style="padding: 14px; text-align:center; color:#fff; font-size: 14px !important; width:max-content; display: inline-block; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">
                    <a>General Settings</a>
                </h1>
                <h1 class="editable"
                    style=" padding-top: 14px; padding-bottom: 14px; text-align:center; color:#fff; font-size: 14px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">

                    <div class="row">
                        <div class="col-12 col-sm-12 col-md-6 col-lg-6" style="align-self: center;">
                            <a>Algorithm Title:</a>
                            <br>
                            <br>
                        </div>
                        <div class="col-12 col-sm-12 col-md-6 col-lg-6">
                            <input style="text-align:center; color:#fff;" placeholder="Algorithm name..."
                                value="{{algorithm.name}}"></input>
                            <br>
                            <br>

                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 col-sm-12 col-md-12 col-lg-12">
                            <a>Algorithm Description:</a>
                            <br>
                        </div>
                    </div>
                    <br>
                    <div class="row">
                        <div class="col-12 col-sm-12 col-md-12 col-lg-12">
                            <textarea id="edit_description" rows="8" style="text-align:left; color:#fff;"
                                placeholder="Enter description here..." value="{{algorithm.description}}"></textarea>
                        </div>
                    </div>
                    <br>
                    <div class="row">
                        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">
                            <a>Public:</a>
                        </div>
                        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">
                            <div class="checkbox">
                                <input style="float:right;" id="public_checkbox" type="checkbox" value="">
                                <label for="public_checkbox"></label>
                            </div>
                        </div>
                        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">
                        </div>
                        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">
                        </div>
                    </div>
                    <br>
                    <div class="row">
                        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">
                            <a>HTML:</a>
                        </div>
                        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">
                            <div class="checkbox">
                                <input style="float:right;" id="html_checkbox" onclick="state.toggle_html()"
                                    type="checkbox" value="">
                                <label for="html_checkbox"></label>
                            </div>
                        </div>
                        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">
                        </div>
                        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">
                        </div>
                    </div>
                    <br>
                    <div id="algorithm_html" class="row" style="display:none;">
                        <div class="col-12 col-sm-12 col-md-12 col-lg-12">
                            <textarea id="algorithm_html_textarea" rows="8"
                                style="text-align:left; border: 1px solid #FFF;" placeholder="Enter html here..."
                                value=""></textarea>
                            <br>
                        </div>
                        <br>
                        <br>
                    </div>
                    <div class="row">
                        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">
                            <a>JavaScript:</a>
                        </div>
                        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">
                            <div class="checkbox">
                                <input style="float:right;" id="javascript_checkbox" onclick="state.toggle_javascript()"
                                    type="checkbox" value="">
                                <label for="javascript_checkbox"></label>
                            </div>
                        </div>
                        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">
                        </div>
                        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">
                        </div>
                    </div>
                    <br>
                    <div id="algorithm_javascript" class="row" style="display:none;">
                        <div class="col-12 col-sm-12 col-md-12 col-lg-12">
                            <textarea id="algorithm_javascript_textarea" rows="8"
                                style="text-align:left; border: 1px solid #FFF;" placeholder="Enter JavaScript here..."
                                value="{{algorithm.client}}"></textarea>
                            <br>
                        </div>
                        <br>
                    </div>
                </h1>

                <h1 class="editable"
                    style="padding: 14px; text-align:center; color:#fff; font-size: 14px !important; width:max-content; display: inline-block; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">
                    <a>Media Files</a>
                </h1>
                <h1 class="editable"
                    style="padding-top: 14px; padding-bottom: 14px;text-align:center; color:#fff; font-size: 14px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">
                    <div class="row">
                        <div class="col-12 col-sm-12 col-md-12 col-lg-12">
                            <a>Image Files:</a>
                            <br>
                        </div>
                    </div>
                    <div class="row" style="border-top: 1px solid #fff;">
                        <div class="col-12 col-sm-12 col-md-12 col-lg-12">
                            <br>
                            <button style="background-color: rgba(0,0,0,.75);" type="button"
                                onclick="state.coming_soon()" class="btn btn-outline-success mx-auto">Add Image</button>
                            <br>
                        </div>
                    </div>
                </h1>
                <h1 class="editable"
                    style="padding-top: 14px; padding-bottom: 14px;text-align:center; color:#fff; font-size: 14px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">
                    <div class="row">
                        <div class="col-12 col-sm-12 col-md-12 col-lg-12">
                            <a>Sound Files:</a>
                            <br>
                        </div>
                    </div>
                    <div class="row" style="border-top: 1px solid #fff;">
                        <div class="col-12 col-sm-12 col-md-12 col-lg-12">
                            <br>
                            <button style="background-color: rgba(0,0,0,.75);" type="button"
                                onclick="state.coming_soon()" class="btn btn-outline-success mx-auto">Add Sound</button>
                            <br>
                        </div>
                    </div>
                </h1>
                <h1 class="editable"
                    style="padding-top: 14px; padding-bottom: 14px;text-align:center; color:#fff; font-size: 14px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">
                    <div class="row">
                        <div class="col-12 col-sm-12 col-md-12 col-lg-12">
                            <a>Video Files:</a>
                            <br>
                        </div>
                    </div>
                    <div class="row" style="border-top: 1px solid #fff;">
                        <div class="col-12 col-sm-12 col-md-12 col-lg-12">
                            <br>
                            <button style="background-color: rgba(0,0,0,.75);" type="button"
                                onclick="state.coming_soon()" class="btn btn-outline-success mx-auto">Add Video</button>
                            <br>
                        </div>
                    </div>
                </h1>

                <div class="editable"
                    style="padding: 14px; width:100%; text-align:center; color:#fff; font-size: 14px !important; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">
                    <a>WebGL Contexts</a>
                    <div id="algorithm_contexts">
                    </div>
                    <button style="background-color: rgba(0,0,0,.75);" type="button"
                        class="btn btn-outline-success mx-auto" onclick="state.add_context()">Add Context</button>
                </div>
                <br>
                <div class="editable"
                    style="padding: 14px; width:100%; text-align:center; color:#fff; font-size: 14px !important; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">
                    <a>WebGL Programs</a>
                    <div id="algorithm_programs">
                    </div>
                    <button style="background-color: rgba(0,0,0,.75);" type="button"
                        class="btn btn-outline-success mx-auto" onclick="state.add_program()">Add Program</button>
                </div>
                <br>
                <div class="editable"
                    style="padding: 14px; width:100%; text-align:center; color:#fff; font-size: 14px !important; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">
                    <a>WebGL Pipeline Stages</a>
                    <div id="algorithm_stages">
                    </div>
                    <br>
                    <button style="background-color: rgba(0,0,0,.75);" type="button"
                        class="btn btn-outline-success mx-auto" onclick="state.add_stage()">Add Pipeline Stage</button>
                </div>
                <br>
                <br>
            </div>
            <div class="col-0 col-sm-0 col-md-1 col-lg-2">
            </div>
        </div>

        <div class="row connected_content" id="delete_account"
            style="display: none; position:absolute; left:0px; top:0px; width:100%; height:100%;">
            <div class="col-0 col-sm-0 col-md-1 col-lg-2">
            </div>
            <div class="col-12 col-sm-12 col-md-10 col-lg-8">
                <div style="height: 7.5%;"></div>

                <h1
                    style="padding: 14px; text-align:left; color:#fff; font-size: 14px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">

                    <div style="text-align:center; color:#f00; font-size: 24px !important;" class="blink-white">
                        This action is permanent and irreversable. Please make sure you actually intend to do this!
                    </div>
                    <br>
                    To delete your account: type the user name or email of this account, the captcha below, and then
                    click "Delete Account". Click "Cancel" to abort account deletion.
                    <br>
                    <br>

                    <table id="delete_table" style="background-color: transparent!important;" class="table table-dark">

                        <tbody>
                            <tr class="form-group" style="background-color: transparent!important;">
                                <th colspan="1" style="vertical-align: bottom;background-color: transparent!important;">
                                    <h1
                                        style="background-color: transparent!important;display: inline-block;text-align:center;color:#fff;font-size: 14px !important;vertical-align: middle;">
                                        Name or Email
                                    </h1>

                                </th>
                                <th colspan="2" style="background-color: transparent!important;">

                                    <input type="text" class="form-control" id="login_name_or_email_delete"
                                        placeholder="Name or Email">
                                </th>
                            </tr>
                            <tr class="form-group" style="background-color: transparent!important;">
                                <th colspan="1">
                                    <img style="display: inline-block; text-align:center; color:#fff; font-size: 14px !important; max-width:100%;"
                                        id="delete_account_captcha">

                                </th>
                                <th colspan="1" style="vertical-align: middle;">
                                    <input type="text" class="form-control" id="delete_account_captcha_input"
                                        placeholder="Captcha">
                                </th>
                            </tr>
                        </tbody>
                    </table>
                    <br>

                    <div style="text-align: center;">
                        <button type="button" class="btn btn-outline-danger mx-auto"
                            onclick="state.delete_account();">Delete
                            Account</button>
                        <button type="button" class="btn btn-outline-warning mx-auto"
                            onclick="state.back();">Cancel</button>
                    </div>
            </div>
            </h1>
        </div>

        <div class="row connected_content" id="profile"
            style="display: none; position:absolute; left:0px; top:0px; width:100%; height:100%;">
            <div class="col-0 col-sm-0 col-md-1 col-lg-2">
            </div>
            <div class="col-12 col-sm-12 col-md-10 col-lg-8">
                <h1
                    style="padding: 14px; text-align:center; color:#fff; font-size: 14px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">
                    Here you can manage your account settings.
                    <br>
                    <br>
                    <div style="text-align: center;">
                        <button type="button" class="btn btn-outline-warning mx-auto"
                            onclick="state.show_page(pages.REQUEST);">Reset
                            Password</button>
                        <button type="button" class="btn btn-outline-danger mx-auto"
                            onclick="state.show_page(pages.DELETE_ACCOUNT);">Delete Account</button>
                    </div>
                </h1>
            </div>
            <div class="col-0 col-sm-0 col-md-1 col-lg-2">
            </div>
        </div>
        <div class="row connected_content" id="query"
            style="display: none; position:absolute; left:0px; top:0px; width:100%; height:100%;">
            <div class="col-0 col-sm-0 col-md-1 col-lg-2">
            </div>
            <div class="col-12 col-sm-12 col-md-10 col-lg-8" style="text-align:center!important">
            </div>
            <div class="col-0 col-sm-0 col-md-1 col-lg-2">
            </div>
        </div>

        <div class="row connected_content" id="login"
            style="display: none; position:absolute; left:0px; top:0px; width:100%; height:100%;">
            <div class="col-0 col-sm-0 col-md-1 col-lg-2">
            </div>
            <div class="col-12 col-sm-12 col-md-10 col-lg-8">
                <h1
                    style="text-align:center; color:#fff; font-size: 14px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">
                    <br>
                    By signing in you agree to our privacy policy:
                    <br>
                    <br>

                    <div style="text-align: center;">
                        <button type="button" class="btn btn-outline-primary mx-auto"
                            onclick="state.show_page(pages.POLICY);">View
                            Privacy Policy</button>
                    </div>
                    <br>
                </h1>
                <br>
                <h1
                    style="text-align:center; color:#fff; font-size: 14px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">
                    <br> You can sign in by entering your credentials below:<br><br>
                    <div
                        style="display: inline-block; text-align:center; color:#fff; font-size: 14px !important; width:50%;">
                        Email or Name
                    </div>
                    <input type="text" style="display: inline-block; font-size: 14px !important; width:40%;"
                        class="form-control" id="login_name_or_email" placeholder="Email/Name">
                    <br>
                    <br>
                    <div
                        style="display: inline-block; text-align:center; color:#fff; font-size: 14px !important; width:50%;">
                        Password
                    </div>
                    <input type="password" style="display: inline-block; font-size: 14px !important; width:40%;"
                        class="form-control" id="login_password" placeholder="Password">
                    <br>
                    <br>
                    <div style="display: inline-block; text-align:center; min-width:50%; max-height:50% !important;">
                        <img style="display: inline-block; text-align:center; color:#fff; font-size: 14px !important; "
                            id="login_captcha">
                    </div>
                    <input type="text" style="display: inline-block; font-size: 14px !important; width:40%;"
                        class="form-control" id="login_captcha_input" placeholder="Captcha">
                    <br>
                    <br>
                    <button type="button" class="btn btn-outline-success mx-auto" onclick="state.login()">Login</button>
                    <br>
                    <br>
                </h1>
                <br>
                <h1
                    style="text-align:center; color:#fff; font-size: 14px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">
                    <br>
                    Not a member? Simply use the "Sign Up" section to register!
                    <br>
                    <br>
                    <button type="button" class="btn btn-outline-success mx-auto"
                        onclick="state.show_page(pages.SIGNUP);">Sign
                        Up</button>
                    <br>
                    <br>
                </h1>
                <br>
                <h1
                    style="text-align:center; color:#fff; font-size: 14px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">
                    <br>
                    Forgot your password? Click below!
                    <br>
                    <br>
                    <button type="button" class="btn btn-outline-warning mx-auto"
                        onclick="state.show_page(pages.REQUEST);">Reset
                        Password</button>
                    <br>
                    <br>
                </h1>
            </div>
            <div class="col-0 col-sm-0 col-md-1 col-lg-2">
            </div>
        </div>
        <div class="row connected_content" id="signup"
            style="display: none; position:absolute; left:0px; top:0px; width:100%; height:100%;">
            <div class="col-0 col-sm-0 col-md-1 col-lg-2">
            </div>
            <div class="col-12 col-sm-12 col-md-10 col-lg-8">
                <h1
                    style="text-align:center; color:#fff; font-size: 14px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">
                    <br>
                    By signing up you agree to our privacy policy:
                    <br>
                    <br>

                    <div style="text-align: center;">
                        <button type="button" class="btn btn-outline-primary mx-auto"
                            onclick="state.show_page(pages.POLICY);">View
                            Privacy Policy</button>
                    </div>
                    <br>
                    You can sign up by giving us the following information, and using the password reset link you
                    receive in
                    your inbox.
                    <br>
                    <br>

                    <div
                        style="display: inline-block; text-align:center; color:#fff; font-size: 14px !important; width:50%;">
                        Your Name
                    </div>
                    <input type="text" style="display: inline-block; font-size: 14px !important; width:40%;"
                        class="form-control" id="signup_name" placeholder="User Name">


                    <br>
                    <br>
                    <div
                        style="display: inline-block; text-align:center; color:#fff; font-size: 14px !important; width:50%;">
                        Your Email</div>
                    <input type="text" style="display: inline-block; font-size: 14px !important; width:40%;"
                        class="form-control" id="signup_email" placeholder="Email">
                    <br>
                    <br>

                    <div style="display: inline-block; width:50%">
                        <img style="display: inline-block; text-align:center; color:#fff; font-size: 14px !important; height:50%;"
                            id="signup_captcha">
                    </div>
                    <input type="text" style="display: inline-block; font-size: 14px !important; width:40%;"
                        class="form-control" id="signup_captcha_input" placeholder="Captcha">
                    <br>
                    <br>
                    <button type="button" class="btn btn-outline-success mx-auto" onclick="state.register()">Sign
                        Up</button>
                    <br>
                    <br>
                </h1>
                <br>

                <h1
                    style="text-align:center; color:#fff; font-size: 14px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">
                    <br>
                    Already a member? Simply click "Login"!
                    <br>
                    <br>
                    <button type="button" class="btn btn-outline-success mx-auto"
                        onclick="state.show_page(pages.LOGIN);">Login</button>
                    <br>
                    <br>
                </h1>
                <br>
                <h1
                    style="text-align:center; color:#fff; font-size: 14px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">
                    <br>
                    Forgot your password? Click below!
                    <br>
                    <br>
                    <button type="button" class="btn btn-outline-warning mx-auto"
                        onclick="state.show_page(pages.REQUEST);">Reset
                        Password</button>
                    <br>
                    <br>
                </h1>
            </div>
            <div class="col-0 col-sm-0 col-md-1 col-lg-2">
            </div>
        </div>
    </div>

    <div fixed id="iframeDiv"
        style="position: fixed; top: 0px; left: 0px; right: 0px; bottom: 0px; height: 100%; width: 100%; z-index: -1;">
        <iframe sandbox="allow-scripts" allow="microphone" style="border: 0; margin: 0px !important;" src="canvas.html"
            id="mainIframe" class="webGLDiv"></iframe>
    </div>

    <script>
        var iframe = null;
        function round(num, places) {
            var multiplier = Math.pow(10, places);
            return Math.round(num * multiplier) / multiplier;
        }

        function load_tree(onload_callback) {
            iframe = document.getElementById("mainIframe");
            iframe.onload = on_resources_loaded;
            iframe.sandbox = "allow-scripts";
            iframe.style.border = "0px";
            iframe.style.margin = "0px !important";

            iframe.style.position = "fixed"
            iframe.style.top = "0px"
            iframe.style.left = "0px"
            iframe.style.right = "0px"
            iframe.style.bottom = "0px"
            iframe.style.height = "100%"
            iframe.style.width = "100%"
            iframe.style.zIndex = "-1"
            iframe.src = "canvas.html";
        }

        //Utility functions
        function getQueryVariable(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split('=');
                if (decodeURIComponent(pair[0]) == variable) {
                    return decodeURIComponent(pair[1]);
                }
            }
            return null;
        }

        //Read URI
        var user_query_param = getQueryVariable("user");
        var code_query_param = getQueryVariable("code");
        var initial_path = window.location.hash;

        //Protocol Buffer Types
        var Message = null;
        var User = null;
        var Captcha = null;

        const MENU = "#menu"

        const pages = {
            RECONNECT: "#reconnect",
            PROCESSING: "#processing",
            RESET: "#reset",
            POLICY: "#policy",
            LOGOUT: "#logout",
            DELETE_ALGORITHM: "#delete_algorithm",
            REQUEST: "#request",
            CLIENT_ERROR: "#client_error",
            SERVER_ERROR: "#server_error",
            HOME: "#home",
            BROWSE: "#browse",
            EDIT: "#edit",
            CREATE: "#create",
            DELETE_ACCOUNT: "#delete_account",
            PROFILE: "#profile",
            LOGIN: "#login",
            SIGNUP: "#signup",
        }
        function is_message_page(page_name) {
            return page_name == pages.CLIENT_ERROR ||
                page_name == pages.SERVER_ERROR ||
                page_name == pages.PROCESSING;
        }
        function Video() {
            this.data = null;
            this.extension = null;
            this.name = "";
        }

        function GlobalState() {
            this.logged_in = false;
            this.user_name = "";
            this.user_email = ""
            this.user_password = ""
            this.websocket = null;
            this.protocol = null;
            this.last_captcha = null;
            this.current_page_state = null;
            this.local_file = null;
            this.video = new Video();
            this.result = null;
            this.page_history = []
            this.first_connection = true;
            this.page_transitions = [];
            this.deleting_algorithm = false;
            this.pipeline = {
                contexts: [],
                programs: [],
                stages: []
            };
            this.context_codemirrors = [];
            this.program_codemirrors = [];
            this.stage_codemirrors = [];
        }
        var Auth, Image, Video, Sound, Person, Comment, MetaAlgorithm,
            Query, Catalog, Vote, OpenGLDimension, OpenGLUniform, OpenGLContext,
            OpenGLProgram, OpenGLStage, OpenGLPipeline, AlgorithmState,
            Algorithm, Custom, Error, Captcha, Message;

        var default_opengl_dimension, default_algorithm_context, default_algorithm_uniform,
            default_algorithm_program, default_algorithm_stage, default_create_algorithm;

        GlobalState.prototype.post_connect_load = function () {

            var routed = false
            for (var p in pages) {
                var page = pages[p];
                if (page.toLowerCase() == initial_path.toLowerCase()) {
                    if (page == pages.RESET && this.first_connection && user_query_param && code_query_param) {
                        this.user_name = user_query_param;
                        this.show_page(pages.RESET, null, null, true, false);
                        this.show_page(pages.PROCESSING, "Validatings...", "Please be patient.", false);
                        this.send(Message.encode({
                            type: Message.Type.VALIDATE,
                            auth: {
                                user: user_query_param,
                                email: "",
                                password: "",
                            },
                            captcha: {
                                key: code_query_param
                            }
                        }).finish())
                        routed = true;
                    }
                    else if (
                        page != pages.RECONNECT &&
                        page != pages.PROCESSING &&
                        page != pages.RESET &&
                        //page != pages.POLICY &&
                        page != pages.LOGOUT &&
                        //page != pages.REQUEST &&
                        page != pages.CLIENT_ERROR &&
                        page != pages.SERVER_ERROR &&
                        page != pages.HOME &&
                        // page != pages.EDIT &&
                        // page != pages.BROWSE &&
                        // page != pages.QUERY &&
                        // page != pages.CREATE_QUERY &&
                        page != pages.DELETE_ACCOUNT &&
                        page != pages.PROFILE) {
                        this.show_page(page);
                        // this.apply_page_change(function (state, title, page) {
                        //     window.history.replaceState(state, title, window.location.protocol + "//" + window.location.host + page);
                        // }.bind(this));
                        routed = true;
                    }
                    break;
                }
            }
            if (!routed) {
                this.back();//show_page(pages.HOME);
            }
            this.first_connection = false;
            //$(".connected_content").css("visibility", "visible");
            this.show_logged_out_content();
        }
        GlobalState.prototype.wait_for_proto_and_connect = function () {
            protobuf.load("proto/messages.proto", function (err, root) {
                if (err)
                    throw err;

                // Obtain a message type
                this.protocol = root;
                // Auth = this.protocol.lookupType("messages.Auth");
                // Video = this.protocol.lookupType("messages.Video");
                // Sound = this.protocol.lookupType("messages.Sound");
                // Person = this.protocol.lookupType("messages.Person");
                // Comment = this.protocol.lookupType("messages.Comment");
                // MetaAlgorithm = this.protocol.lookupType("messages.MetaAlgorithm");
                // Query = this.protocol.lookupType("messages.Query");
                // Catalog = this.protocol.lookupType("messages.Catalog");
                // Vote = this.protocol.lookupType("messages.Vote");
                OpenGLDimension = this.protocol.lookupType("messages.OpenGLDimension");
                OpenGLUniform = this.protocol.lookupType("messages.OpenGLUniform");
                // OpenGLContext = this.protocol.lookupType("messages.OpenGLContext");
                // OpenGLProgram = this.protocol.lookupType("messages.OpenGLProgram");
                OpenGLStage = this.protocol.lookupType("messages.OpenGLStage");
                // OpenGLPipeline = this.protocol.lookupType("messages.OpenGLPipeline");
                // AlgorithmState = this.protocol.lookupType("messages.AlgorithmState");
                // Algorithm = this.protocol.lookupType("messages.Algorithm");
                // Custom = this.protocol.lookupType("messages.Custom");
                // Error = this.protocol.lookupType("messages.Error");
                // Captcha = this.protocol.lookupType("messages.Captcha");
                Message = this.protocol.lookupType("messages.Message");

                default_opengl_dimension = {
                    type: OpenGLDimension.Type.SCREEN_SIZE,
                    exact_value: "//Retrun the floating point value of a javascript evaulation here. It is re-evaluated every frame."
                }

                default_algorithm_context = {
                    name: "",
                    width: JSON.parse(JSON.stringify(default_opengl_dimension)),
                    height: JSON.parse(JSON.stringify(default_opengl_dimension)),
                    depth_test: false
                }

                default_algorithm_uniform = {
                    type: OpenGLUniform.Type.FLOAT,
                    name: "",
                    value: "return 0;"
                }
                default_algorithm_program = {
                    name: "",
                    uniforms: [],
                    frag_code:

                        "precision highp float;\n" +
                        "precision highp int;\n" +
                        "\n" +
                        "#define UNIFORM_INSERTION_POINT\n" +
                        "\n" +
                        "varying vec2 vPosition;\n" +
                        "        \n" +
                        "void main()\n" +
                        "{\n" +
                        "    vec2 uv = vPosition;\n" +
                        "    gl_FragColor.rgb = vec3(sin(uv+time), sin(time));\n" +
                        "    gl_FragColor.a = 1.0;\n" +
                        "}",
                    vert_code:

                        "precision highp float;\n" +
                        "precision highp int;\n" +
                        "\n" +
                        "#define UNIFORM_INSERTION_POINT\n" +
                        "\n" +
                        "attribute highp vec4 vertex; \n" +
                        "\n" +
                        "varying vec2 vPosition;\n" +
                        "void main(void) {\n" +
                        "    vPosition = vertex.xy;\n" +
                        "    gl_Position = vec4(vPosition*2.-1., 0., 1.);\n" +
                        "}"
                }

                default_algorithm_stage = {
                    name: "",
                    type: OpenGLStage.Type.SHADER,
                    context_name: "",
                    program_name: "",
                    mesh_vertices_eval: "return []; // Return vertices array.",
                    mesh_indices_eval: "return []; //Return indices to vertices array."
                }

                default_create_algorithm = {
                    type: Message.Type.ALGORITHM,
                    state: {
                        has_html: false,
                        has_client: true,
                        has_server: false
                    },
                    html: null,
                    client:
                        "var canvas = pipeline.contexts[pipeline.contexts.length-1].canvas;\n" +
                        "\n" +
                        "canvas.style.position = \'fixed\';\n" +
                        "canvas.style.width = \'100%\';\n" +
                        "canvas.style.height = \'100%\';\n" +
                        "document.body.prepend(canvas);\n" +
                        "function res(){\n" +
                        "    pipeline.contexts[pipeline.contexts.length-1].resizeCanvas()\n" +
                        "}\n" +
                        "window.addEventListener('resize', res);\n" +
                        "",
                    pipeline: {
                        contexts: [
                            {
                                name: 'image-context',
                                width: {
                                    type: OpenGLDimension.Type.SCREEN_SIZE,
                                    exact_value: ""
                                },
                                height: {
                                    type: OpenGLDimension.Type.SCREEN_SIZE,
                                    exact_value: ""
                                },
                                depth_test: false
                            }
                        ],
                        programs: [
                            {
                                name: 'output-program',
                                uniforms: [
                                    {
                                        type: OpenGLUniform.Type.SAMPLER_TWO_D,
                                        name: 'flip_texture',
                                        value:
                                            "var context = pipeline.getContext(\'image-context\');\n" +
                                            "context.gl.bindFramebuffer(context.gl.FRAMEBUFFER, null);\n" +
                                            "if(!context.flip_texture) return 0;\n" +
                                            "context.gl.activeTexture(context.gl.TEXTURE0);\n" +
                                            "context.gl.bindTexture(context.gl.TEXTURE_2D, context.flip_texture);\n" +
                                            "context.gl.texParameteri(context.gl.TEXTURE_2D, context.gl.TEXTURE_MAG_FILTER, context.gl.NEAREST);\n" +
                                            "context.gl.texParameteri(context.gl.TEXTURE_2D, context.gl.TEXTURE_MIN_FILTER, context.gl.NEAREST);\n" +
                                            "context.gl.texParameteri(context.gl.TEXTURE_2D, context.gl.TEXTURE_WRAP_S, context.gl.CLAMP_TO_EDGE);\n" +
                                            "context.gl.texParameteri(context.gl.TEXTURE_2D, context.gl.TEXTURE_WRAP_T, context.gl.CLAMP_TO_EDGE);\n" +
                                            "return 0;"
                                    },
                                    {
                                        type: OpenGLUniform.Type.FLOAT,
                                        name: 'width',
                                        value: 'return pipeline.getContext(\'image-context\').canvas.width;'
                                    },
                                    {
                                        type: OpenGLUniform.Type.FLOAT,
                                        name: 'height',
                                        value: 'return pipeline.getContext(\'image-context\').canvas.height;'
                                    },
                                    {
                                        type: OpenGLUniform.Type.FLOAT,
                                        name: 'time',
                                        value:
                                            'if(!this.timeUniformStart) this.timeUniformStart = ((new Date()).getTime())/1E3;\n' +
                                            '   return ((new Date()).getTime())/1E3-this.timeUniformStart;'
                                    }
                                ],
                                frag_code:

                                    "#extension GL_OES_standard_derivatives : enable\n" +
                                    "precision highp float;\n" +
                                    "precision highp int;\n" +
                                    "\n" +
                                    "#define UNIFORM_INSERTION_POINT\n" +
                                    "\n" +
                                    "varying vec2 vPosition;\n" +
                                    "        \n" +
                                    "void main()\n" +
                                    "{\n" +
                                    "    vec2 uv = vPosition;\n" +
                                    "    gl_FragColor.rgb = vec3(sin(uv+time), sin(time));\n" +
                                    "    gl_FragColor.a = 1.0;\n" +
                                    "}\n",
                                vert_code:
                                    "precision highp float;\n" +
                                    "precision highp int;\n" +
                                    "\n" +
                                    "#define UNIFORM_INSERTION_POINT\n" +
                                    "\n" +
                                    "attribute highp vec4 vertex; \n" +
                                    "\n" +
                                    "varying vec2 vPosition;\n" +
                                    "void main(void) {\n" +
                                    "    vPosition = vertex.xy;\n" +
                                    "    gl_Position = vec4(vPosition*2.-1., 0., 1.);\n" +
                                    "}\n"
                            }
                        ],
                        stages: [
                            {
                                type: OpenGLStage.Type.SHADER,
                                context_name: 'image-context',
                                program_name: 'output-program',
                                mesh_vertices_eval: null,
                                mesh_indices_eval: null
                            }
                        ]
                    }
                };

                this.set_ui_algorithm(default_create_algorithm);
                if (iframe) iframe.contentWindow.postMessage(JSON.stringify({ proto: default_create_algorithm }), '*');

                this.show_page(pages.PROCESSING, "Connecting...", "Please be patient.", false, true);
                this.connect();
            }.bind(this));
        }
        GlobalState.prototype.reconnect = function () {
            this.back(false);
            this.show_page(pages.PROCESSING, "Reconnecting...", "Please be patient.", false, true);
            this.connect();
        }
        GlobalState.prototype.connect = function () {
            this.websocket = new WebSocket("wss://" + window.location.hostname);

            this.websocket.binaryType = "arraybuffer";
            this.websocket.onclose = function (event) {
                this.logged_in = false;
                //$(".connected_content").css("visibility", "hidden");
                this.show_logged_out_content();
                this.page_history = [];
                this.show_page(pages.LOGIN, null, null, null, false);
                this.show_page(pages.RECONNECT, null, null, true, false)
                this.show_page(pages.CLIENT_ERROR, "Connection closed. Code: " + event.code, "If you were logged in, you are now logged out.", true, true);
            }.bind(this)
            this.websocket.onmessage = function (event) {
                try {
                    var decoded = Message.decode(new Uint8Array(event.data));
                    this.handle_message(decoded);
                }
                catch (e) {
                    this.show_page(pages.CLIENT_ERROR, "Error! Could not decode server response", e + "", true);
                }
            }.bind(this);
            this.websocket.onopen = function () {
                /*
                $(".disconnected_content").css("visibility", "visible");
                
                if (this.websocket && this.websocket.readyState == WebSocket.OPEN)
                    $(".connected_content").css("visibility", "visible");
                else
                    $(".connected_content").css("visibility", "hidden");
                */
                if (!this.first_connection)
                    this.back();
                this.post_connect_load()
            }.bind(this);

            //$(".disconnected_content").css("visibility", "visible");
        }

        GlobalState.prototype.send = function (encoded, request_updates = false) {
            this.websocket.send(encoded.length);

            if (request_updates)
                this.websocket.send(1);
            else
                this.websocket.send(0);
            var fragment_size = 1024 * 512;
            for (var i = 0; i < encoded.length; i += fragment_size) {
                var start = i;
                var end = i + fragment_size;
                this.websocket.send(encoded.subarray(start, end));
            }
        }
        GlobalState.prototype.refresh_captchas = function () {
            if (this.websocket && this.websocket.readyState == WebSocket.OPEN)
                this.send(Message.encode({ type: Message.Type.CAPTCHA }).finish());
        }

        GlobalState.prototype.handle_message = function (proto) {
            console.log(proto);

            if (proto.type == Message.Type.LOGIN) {
                this.user_name = proto.auth.user;
                this.user_email = proto.auth.email;
                //this.user_password = proto.auth.password;
                this.hash = proto.auth.hash;
                this.logged_in = true;
                this.show_page(pages.HOME);
            }
            if (proto.type == Message.Type.AUTH) {
                this.hash = proto.auth.hash;
            }
            else if (proto.type == Message.Type.SET_PASSWORD) {
                this.show_page(pages.PROCESSING, proto.message, proto.details, true, true);
            }
            else if (proto.type == Message.Type.HALT) {
                this.show_page(pages.PROCESSING, proto.message, proto.details, false, true);
            }
            else if (proto.type == Message.Type.PROGRESS) {
                if (this.deleting_algorithm) {
                    return;
                }
                this.show_page(pages.PROCESSING, proto.message, proto.details, true, true);
                this.video.data = null;
                this.redraw_edit_form();
            }
            else if (proto.type == Message.Type.DELETE_ALGORITHM) {
                if (this.deleting_algorithm) {
                    this.deleting_algorithm = false;
                }
                this.back(false);
                this.show_page(pages.PROCESSING, proto.message, proto.details, true, true);
                this.redraw_edit_form();
            }
            else if (proto.type == Message.Type.ERROR) {
                this.show_page(pages.SERVER_ERROR, proto.message, proto.details, true, true);
            }
            else if (proto.type == Message.Type.CAPTCHA) {


                var base_64_encoded = btoa(String.fromCharCode.apply(null, proto.captcha.image));

                this.unfiltered_captcha_image = document.createElement('img');
                this.unfiltered_captcha_image.onload = (function () {
                    var canvas = document.createElement('canvas');
                    canvas.width = this.unfiltered_captcha_image.width;
                    canvas.height = this.unfiltered_captcha_image.height;

                    var ctx = canvas.getContext("2d");

                    ctx.drawImage(this.unfiltered_captcha_image, 0, 0);
                    ctx.globalCompositeOperation = 'difference';
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    var image_data = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    var real_max = 0;
                    var real_min = 1E32;
                    for (var i = 0; i < image_data.data.length; i += 4) {
                        var max = Math.max(image_data.data[i], Math.max(image_data.data[i + 1], image_data.data[i + 2]));
                        var min = Math.min(image_data.data[i], Math.min(image_data.data[i + 1], image_data.data[i + 2]));
                        if (max < 32) {
                            image_data.data[i + 3] = 0; // alpha
                        }
                        else
                            real_min = Math.min(real_min, min);
                        real_max = Math.max(real_max, max);
                    }

                    for (var i = 0; i < image_data.data.length; i += 4) {
                        image_data.data[i] = (image_data.data[i] - real_min) / (real_max - real_min) * 256.;
                        image_data.data[i + 1] = (image_data.data[i + 1] - real_min) / (real_max - real_min) * 256.;
                        image_data.data[i + 2] = (image_data.data[i + 2] - real_min) / (real_max - real_min) * 256.;
                    }

                    ctx.putImageData(image_data, 0, 0);
                    var new_url = canvas.toDataURL();

                    $('#signup_captcha').attr('src', new_url);
                    $('#login_captcha').attr('src', new_url);
                    $('#reset_captcha').attr('src', new_url);
                    $('#request_captcha').attr('src', new_url);
                    $('#edit_captcha').attr('src', new_url);
                    $('#query_captcha').attr('src', new_url);
                    $('#delete_account_captcha').attr('src', new_url);

                    $('#signup_captcha_input').val("");
                    $('#login_captcha_input').val("");
                    $('#reset_captcha_input').val("");
                    $('#request_captcha_input').val("");
                    $('#edit_captcha_input').val("");
                    $('#query_captcha_input').val("");
                    $('#delete_account_captcha_input').val("");
                }).bind(this);
                this.unfiltered_captcha_image.src = `data:image/png;base64,${base_64_encoded}`

                this.last_captcha = proto.captcha;
            }
        }


        GlobalState.prototype.register = function () {
            var name = $("#signup_name").val();
            var valid_name = name.length >= 3;

            if (!valid_name) {
                this.show_page(pages.CLIENT_ERROR, "Error!", "Please enter a valid user name (use 3 or more characters).", true);
                return;
            }

            var email = $("#signup_email").val();
            var valid_email = /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(email);

            if (!valid_email) {
                this.show_page(pages.CLIENT_ERROR, "Error!", "Please enter a valid email.", true);
                return;
            }

            var captcha = $("#signup_captcha_input").val();
            this.show_page(pages.PROCESSING, "Registering...", "Please be patient.", false, true);

            this.send(Message.encode({
                type: Message.Type.REGISTER,
                auth: {
                    user: name,
                    email: email,
                    password: ""
                },
                captcha: {
                    key: captcha
                }
            }).finish())
        }

        GlobalState.prototype.login = function () {
            var email_or_name = $("#login_name_or_email").val();
            var pwd = $("#login_password").val();
            var captcha = $("#login_captcha_input").val();


            this.show_page(pages.PROCESSING, "Logging in...", "Please wait...", false, true);
            this.send(Message.encode({
                type: Message.Type.LOGIN,
                auth: {
                    user: email_or_name,
                    email: email_or_name,
                    password: pwd
                },
                captcha: {
                    key: captcha
                }
            }).finish())
        }

        GlobalState.prototype.delete_account = function () {
            var value_entered = $("#login_name_or_email_delete").val()
            var captcha = $("#delete_account_captcha").val();
            if (this.user_name.toLowerCase() == (value_entered).toLowerCase() || this.user_email.toLowerCase() == (value_entered).toLowerCase()) {


                this.show_page(pages.PROCESSING, "Deleting account...", "Please wait...", false, true);
                this.send(Message.encode({
                    type: Message.Type.DELETE_ACCOUNT,
                    auth: {
                        user: this.user_name,
                        email: this.user_email,
                        hash: this.hash
                    },
                    captcha: {
                        key: captcha
                    }
                }).finish())
            }
        }
        GlobalState.prototype.logout = function () {
            if (this.websocket.readyState == WebSocket.OPEN) {
                this.show_page(pages.PROCESSING, "Logging out...", "Please wait...", false);
                this.websocket.close();
            }
        }

        GlobalState.prototype.send_request = function () {

            var name_or_email = $("#request_password_reset").val();
            var valid_name = name_or_email.length >= 3;
            var valid_email = /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(name_or_email);

            if (!valid_name && !valid_email) {
                this.show_page(pages.CLIENT_ERROR, "Error!", "Please enter a valid name or email.", true);
                return;
            }

            var captcha = $("#request_captcha_input").val();


            this.show_page(pages.PROCESSING, "Sending request...", "Please wait...", false, true);
            this.send(Message.encode({
                type: Message.Type.REQUEST_PASSWORD_RESET,
                auth: {
                    user: name_or_email,
                    email: name_or_email,
                    password: ""
                },
                captcha: {
                    key: captcha
                }
            }).finish())
        }
        GlobalState.prototype.set_password = function () {
            var pwd = $("#reset_password").val()
            if (pwd != $("#reset_retype").val()) {
                this.show_page(pages.CLIENT_ERROR, "Error!", "Please enter passwords that match. Use at least one number, at least one letter, and at least six characters.", true);
                return;
            }
            var valid_pwd = /(?=.*\d)(?=.*[a-zA-Z]).{6,}/.test(pwd);
            if (!valid_pwd) {
                this.show_page(pages.CLIENT_ERROR, "Error!", "Please enter a valid password. Use at least one number, at least one letter, and at least six characters.", true);
                return;
            }

            var captcha = $("#reset_captcha_input").val();


            this.show_page(pages.PROCESSING, "Setting password...", "Please wait...", false, true);
            this.send(Message.encode({
                type: Message.Type.SET_PASSWORD,
                auth: {
                    user: this.user_name,
                    password: pwd
                },
                captcha: {
                    key: captcha
                }
            }).finish())
        }

        GlobalState.prototype.show_logged_out_content = function (new_page) {
            $.each($(".logged_in_content"), function () {
                if ($(this).is(":visible") && ($(new_page).has($(this)).length > 0 || $(this).parents().has(MENU).length > 0))
                    $(this).fadeOut(1000);
            });
            $.each($(".logged_out_content"), function () {
                if ($(this).is(":hidden") && ($(new_page).has($(this)).length > 0 || $(this).parents().has(MENU).length > 0))
                    $(this).fadeIn(1000);
            });
        }
        GlobalState.prototype.show_logged_in_content = function (new_page) {
            $.each($(".logged_in_content"), function () {
                //if($(this).is(":hidden") && 
                if (($(new_page).has($(this)).length > 0 || $(this).parents().has(MENU).length > 0))
                    $(this).fadeIn(1000);
            });
            $.each($(".logged_out_content"), function () {
                //if($(this).is(":visible") && 
                if (($(new_page).has($(this)).length > 0 || $(this).parents().has(MENU).length > 0))
                    $(this).fadeOut(1000);
            });
        }

        GlobalState.prototype.show_page = function (page = pages.HOME, message = null, subtext = null, opt_out = true, should_show_page = true, is_back_action = false) {

            if (this.moving) {
                show_page_params = [page, message, subtext, opt_out, should_show_page];
                this.page_transitions.push(show_page_params)
                return;
            }
            else if (is_message_page(this.current_page) && this.current_page_state.opt_out && !is_back_action) {
                var new_page_state =
                {
                    page: page,
                    message: message,
                    subtext: subtext,
                    opt_out: opt_out,
                    should_show_page: should_show_page
                };
                var top_page = this.page_history.pop()
                this.page_history = this.page_history.concat([new_page_state]).concat([top_page]);
                return;
            }
            else if (is_message_page(this.current_page) && !this.current_page_state.opt_out) {
                this.page_history.pop()
            }

            console.log("SHOWPAGE: " + page);

            var move_on = (() => {

                var new_page_state =
                {
                    page: page,
                    message: message,
                    subtext: subtext,
                    opt_out: opt_out,
                    should_show_page: should_show_page
                };
                var new_current_page = page;
                this.current_page_state =
                {
                    page: page,
                    message: message,
                    subtext: subtext,
                    opt_out: opt_out,
                    should_show_page: should_show_page
                };
                this.current_page = page;
                this.apply_page_change(function (page_state, title, page) {
                    window.history.pushState(page_state, title, window.location.protocol + "//" + window.location.host + page);
                }.bind(this));
                this.page_history.push(this.current_page_state)
                /*
 
                for (var i = floating_pages.length - 1; i >= 0; i--) {
                    var floating_page = this.page_history[floating_pages[i]]
                    this.current_page = floating_page.page;
                    this.apply_page_change(function (page_state, title, floating_page) {
                        window.history.pushState(page_state, title, window.location.protocol + "//" + window.location.host + page);
                    }.bind(this));
                    this.page_history.push(floating_page)
                }
 
                */
            }).bind(state);

            var transition = (() => {
                if (this.logged_in)
                    this.show_logged_in_content(page)
                else
                    this.show_logged_out_content(page);
                if (this.page_transitions.length > 0) {
                    var transition = this.page_transitions.shift()
                    this.show_page(transition[0],
                        transition[1],
                        transition[2],
                        transition[3],
                        transition[4]);
                }
            }).bind(state);
            var fill_content = (() => {
                switch (page) {
                    case pages.RECONNECT:
                        $("#menu").fadeOut(1000);
                        break;
                    case pages.PROCESSING:
                        $("#menu").fadeOut(1000);
                        $("#processing_header").text(message);
                        $("#processing_message").text(subtext);

                        if (opt_out)
                            $(".opt_out").fadeIn(1000);
                        else
                            $(".opt_out").fadeOut(1000);
                        break;
                    case pages.RESET:
                        this.refresh_captchas();
                        $("#menu").fadeOut(1000);
                        break;
                    case pages.POLICY:
                        $("#menu").fadeOut(1000);
                        break;
                    case pages.REQUEST:
                        this.refresh_captchas();
                        $("#menu").fadeOut(1000);
                        break;
                    case pages.CLIENT_ERROR:
                        $("#menu").fadeOut(1000);
                        $("#client_error_header").text(message);
                        $("#client_error_message").text(subtext);

                        if (opt_out)
                            $(".opt_out").fadeIn(1000);
                        else
                            $(".opt_out").fadeOut(1000);
                        break;
                    case pages.SERVER_ERROR:
                        $("#menu").fadeOut(1000);
                        $("#server_error_header").text(message);
                        $("#server_error_message").text(subtext);

                        if (opt_out)
                            $(".opt_out").fadeIn(1000);
                        else
                            $(".opt_out").fadeOut(1000);
                        break;
                    case pages.HOME:
                        $("#menu").fadeIn(1000);
                        break;
                    case pages.BROWSE:
                        $("#browse").fadeIn(1000);
                        $("#menu").fadeIn(1000);
                        break;
                    case pages.EDIT:
                        this.refresh_captchas();
                        this.redraw_edit_form();
                        $("#menu").fadeIn(1000);
                        break;
                    case pages.CREATE:
                        $("#create").fadeIn(1000);
                        $("#menu").fadeIn(1000);
                        break;
                    case pages.DELETE_ACCOUNT:
                        this.refresh_captchas();
                        $("#menu").fadeOut(1000);
                        break;
                    case pages.PROFILE:
                        $("#menu").fadeIn(1000);
                        break;
                    case pages.LOGIN:
                        this.refresh_captchas();
                        $("#menu").fadeIn(1000);
                        break;
                    case pages.SIGNUP:
                        this.refresh_captchas();
                        $("#menu").fadeIn(250);
                        break;
                }
                if (this.logged_in)
                    this.show_logged_in_content(page)
                else
                    this.show_logged_out_content(page);
            }).bind(state);

            /*
            var floating_pages = []
            for (var i = 0; i < this.page_history.length; i++) {
                var last_viable_page = this.page_history[i]
                if (is_message_page(last_viable_page.page) && last_viable_page.opt_out == true) {
                    floating_pages.push(i);
                }
            }
            var new_page_state =
            {
                page: page,
                message: message,
                subtext: subtext,
                opt_out: opt_out,
                should_show_page: should_show_page
            };
            var new_current_page = page;
            if(floating_pages.length > 0)
            {
                floating_start = this.page_history.length-floating_pages.length;
                this.page_history = this.page_history.slice(0, floating_start).concat([new_page_state]).concat(this.page_history.slice(floating_start));
            }
 
            else */
            if (this.current_page_state && (this.current_page_state.page != page || this.current_page_state.message != message || this.current_page_state.subtext != subtext)) {
                this.moving = true;

                var fade_in = ((page, should_show_page) => {
                    if (should_show_page) {
                        fill_content();

                        $(page).fadeIn(1000).promise().then(
                            (() => {
                                move_on()
                                this.moving = false;
                                transition()
                            }).bind(state)
                        );
                    }
                    else {
                        move_on()
                        this.moving = false;
                        transition()
                    }
                }).bind(state, page, should_show_page);

                if (this.current_page_state.page == page)
                    fade_in();
                else
                    $(this.current_page).fadeOut(1000).promise().then(fade_in);
            }
            else {
                this.moving = true;
                move_on()
                this.moving = false;
                fill_content();
                transition()
            }
        }
        GlobalState.prototype.apply_page_change = function (change_function) {
            var page = this.current_page;
            var message = "";
            switch (page) {
                case pages.RECONNECT:
                    message = "Reconnect";
                    break;
                case pages.PROCESSING:
                    message = "Processing";
                    break;
                case pages.RESET:
                    message = "Password Reset";
                    break;
                case pages.POLICY:
                    message = "Site Policies";
                    break;
                case pages.REQUEST:
                    message = "Request Password Reset";
                    break;
                case pages.CLIENT_ERROR:
                    message = "Client Error";
                    break;
                case pages.SERVER_ERROR:
                    message = "Server Error";
                    break;
                case pages.HOME:
                    message = "General Information";
                    break;
                case pages.BROWSE:
                    message = "Browse Algorithms";
                    break;
                case pages.EDIT:
                    message = "Edit Algorithm";
                    break;
                case pages.CREATE:
                    message = "Create Algorithm";
                    break;
                case pages.CREATE_QUERY:
                    message = "Create Visual Query";
                    break;
                case pages.DELETE_ACCOUNT:
                    message = "Delete Account";
                    break;
                case pages.PROFILE:
                    message = "Profile";
                    break;
                case pages.LOGIN:
                    message = "Log In";
                    break;
                case pages.SIGNUP:
                    message = "Sign Up";
                    break;
            }
            change_function(this.current_page_state, message, page);
        }

        GlobalState.prototype.redraw_profile_form = function () {
            // var edited_videos_table = "";

            // if (!this.profile_results || !this.profile_results.catalog || this.profile_results.catalog.length == 0) {
            //     $(".edit_present").fadeOut(1000);
            //     $(".edit_absent").fadeIn(1000);
            // }
            // else {
            //     $(".edit_present").fadeIn(1000);
            //     $(".edit_absent").fadeOut(1000);
            //     for (var i = 0; i < this.profile_results.catalog.videos.length; i++) {

            //         edited_videos_table +=
            //             `<tr>
            //         <th style="vertical-align: middle;">
            //             <img style="display: inline-block; text-align:center; color:#fff; font-size: 14px !important; max-height:128px;"
            //                         id="request_captcha" src="`+ this.profile_results.catalog.videos[i].thumbnail + `"></th>
            //         <th style="vertical-align: middle;"><br>"`+
            //             this.profile_results.catalog.videos[i].clientName + `"<br><br>` +
            //             `<button type="button" class="btn btn-outline-success mx-auto"
            //                 onclick="state.preview_profile_result(`+ i + `);">Preview</button>` + `<br><br>` +
            //             `<button type="button" class="btn btn-outline-danger mx-auto"
            //                 onclick="state.start_video_delete(`+ i + `);">Delete</button>` + `<br><br>` +
            //             `</th>
            //         </tr>`
            //     }

            //     $("#edited_videos_table").html(edited_videos_table)
            // }
        }
        GlobalState.prototype.start_video_delete = function (index) {
            window.delete_algorithm_index = index;
            this.show_page(pages.DELETE_ALGORITHM);
        }
        GlobalState.prototype.end_algorithm_delete = function () {
            this.show_page(pages.PROCESSING, "Deleting algorithm...", "Please be patient.", false, true);

            var json = {
                type: Message.Type.DELETE_ALGORITHM,
                auth: {
                    user: this.user_name,
                    hash: this.hash
                },
                video: {
                    serverName: this.profile_results.catalog.videos[window.delete_algorithm_index].serverName
                }
            }

            var encoded = Message.encode(json).finish();

            this.deleting_algorithm = true;
            this.send(encoded);
        }

        GlobalState.prototype.redraw_edit_form = function () {
        }

        GlobalState.prototype.back = function (show_page = true) {
            if (state.page_history.length == 0)
                this.show_page(pages.HOME)
            else {
                var last_viable_page = state.page_history.pop()
                if (state.page_history.length == 0) {
                    this.show_page(pages.HOME, null, null, true, true, true)
                    return;
                }
                last_viable_page = state.page_history.pop()
                while (state.page_history.length > 0 &&
                    (!last_viable_page.opt_out ||
                        last_viable_page.page == pages.LOGOUT))
                    last_viable_page = state.page_history.pop()

                this.show_page(last_viable_page.page,
                    last_viable_page.message,
                    last_viable_page.subtext,
                    last_viable_page.opt_out,
                    show_page, true);
            }
        }

        GlobalState.prototype.pop_page = function (pop_event) {
            this.current_page_state = pop_event ? pop_event.state : null;

            state.back();
        }
        GlobalState.prototype.toggle_html = function () {
            var c = $("#html_checkbox")
            var has_html = c.prop("checked");

            if (has_html)
                $("#algorithm_html").show();
            else
                $("#algorithm_html").hide();
        }
        GlobalState.prototype.toggle_javascript = function () {
            var c = $("#javascript_checkbox")
            var has_javascript = c.prop("checked");

            if (has_javascript)
                $("#algorithm_javascript").show();
            else
                $("#algorithm_javascript").hide();
        }
        GlobalState.prototype.coming_soon = function () {
            this.show_page(pages.PROCESSING, "This feature is coming soon!", "Please check again at a later date.", true, true);
        }

        GlobalState.prototype.mutex_checkboxes = function (checkboxes, global_change) {
            for (var i = 0; i < checkboxes.length; i++) {
                document.getElementById(checkboxes[i]).onclick = (function (checkboxes, i, global_change) {
                    return function (event) {
                        var mutex_these = [];
                        var skipped_checkbox = null;
                        for (var j = 0; j < checkboxes.length; j++) {
                            if (j == i) {
                                skipped_checkbox = checkboxes[j];
                                continue;
                            }
                            mutex_these.push(checkboxes[j]);
                        }

                        var total_mutex = true;
                        for (var j = 0; j < mutex_these.length; j++)
                            total_mutex = (!$("#" + mutex_these[j]).prop("checked")) && total_mutex;

                        if (total_mutex) {
                            $("#" + skipped_checkbox).prop("checked", true);
                        }
                        else {
                            for (var j = 0; j < checkboxes.length; j++) {
                                if (j == i)
                                    continue;
                                $("#" + checkboxes[j]).prop("checked", false)
                            }
                        }
                        if (global_change)
                            global_change();
                    }
                })(checkboxes, i, global_change)
            }
        }

        GlobalState.prototype.get_context_by_name = function (name) {
            for (var i = 0; i < this.pipeline.contexts.length; i++)
                if (name == this.pipeline.contexts[i].name)
                    return this.pipeline.contexts[i];
            return null;
        }
        GlobalState.prototype.render_contexts = function (contexts) {
            var html = "";
            for (var i = 0; i < contexts.length; i++) {
                var context = contexts[i];

                if (!window.context_counter)
                    window.context_counter = 0;
                var new_context_index = window.context_counter++;

                var name_prefix = "context_identifier_";
                var context_identifier = name_prefix + new_context_index;
                this.pipeline.contexts[i].identifier = context_identifier;
                context.identifier = context_identifier;

                html +=
                    '<h1 class="editable" id="' + context_identifier + '" \n' +
                    'style="padding-top: 14px; padding-bottom: 14px;text-align:center; color:#fff; font-size: 14px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">\n' +
                    '   <div class="row">\n' +
                    '        <div class="col-12 col-sm-12 col-md-6 col-lg-6" style="align-self: center;">\n' +
                    '            <a>Context Identifier:</a>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '        <div class="col-12 col-sm-12 col-md-6 col-lg-6">\n' +
                    '            <input id="' + context_identifier + '_name" style="text-align:center; color:#fff;" placeholder="Context name..."\n' +
                    '                value="' + context.name + '"></input>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>Depth Component:</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + context_identifier + '_depth_checkbox" type="checkbox" ' + (context.depth_test ? "checked" : "") + '>\n' +
                    '                <label for="' + context_identifier + '_depth_checkbox"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row" style="border-top: 1px solid #fff;">\n' +
                    '        <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                    '            <br>\n' +
                    '            <a>Context Width:</a>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>SCREEN SIZE</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + context_identifier + '_width_screen_size" type="checkbox">\n' +
                    '                <label for="' + context_identifier + '_width_screen_size"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>SNEXT LOWEST POWER OF TWO</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + context_identifier + '_width_next_lowest_power_of_two" type="checkbox">\n' +
                    '                <label for="' + context_identifier + '_width_next_lowest_power_of_two"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>NEXT HIGHEST POWER OF TWO</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + context_identifier + '_width_next_highest_power_of_two" type="checkbox">\n' +
                    '                <label for="' + context_identifier + '_width_next_highest_power_of_two"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>EXACT</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + context_identifier + '_width_exact" type="checkbox">\n' +
                    '                <label for="' + context_identifier + '_width_exact"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                    '            <textarea id="' + context_identifier + '_width_exact_js" rows="8"\n' +
                    '                style="text-align:left; border: 1px solid #FFF;" placeholder="Enter JavaScript here..."\n' +
                    '                value="{{algorithm.client}}"></textarea>\n' +
                    '        </div>\n' +
                    '        <br>\n' +
                    '    </div>\n' +
                    '    <br>\n' +



                    '    <div class="row" style="border-top: 1px solid #fff;">\n' +
                    '        <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                    '            <br>\n' +
                    '            <a>Context Height:</a>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>SCREEN SIZE</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + context_identifier + '_height_screen_size" type="checkbox">\n' +
                    '                <label for="' + context_identifier + '_height_screen_size"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>SNEXT LOWEST POWER OF TWO</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + context_identifier + '_height_next_lowest_power_of_two" type="checkbox">\n' +
                    '                <label for="' + context_identifier + '_height_next_lowest_power_of_two"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>NEXT HIGHEST POWER OF TWO</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + context_identifier + '_height_next_highest_power_of_two" type="checkbox">\n' +
                    '                <label for="' + context_identifier + '_height_next_highest_power_of_two"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>EXACT</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + context_identifier + '_height_exact" type="checkbox">\n' +
                    '                <label for="' + context_identifier + '_height_exact"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                    '            <textarea id="' + context_identifier + '_height_exact_js" rows="8"\n' +
                    '                style="text-align:left; border: 1px solid #FFF;" placeholder="Enter JavaScript here..."\n' +
                    '                value="{{algorithm.client}}"></textarea>\n' +
                    '        </div>\n' +
                    '        <br>\n' +
                    '    </div>\n' +

                    '    <br>\n' +
                    '\n' +
                    '\n' +
                    '\n' +
                    '\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                    '            <button type="button" ' + (i == 0 ? "disabled" : "onclick='state.move_context_up(" + i + ")'") + ' id="' + context_identifier + '_move_up" class="btn btn-outline-warning mx-auto">Move Context Up</button>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                    '            <button type="button" ' + (i == contexts.length - 1 ? "disabled" : "onclick='state.move_context_down(" + i + ")'") + ' id="' + context_identifier + '_move_down" class="btn btn-outline-warning mx-auto">Move Context Down</button>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '\n' +
                    '\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                    '            <button type="button" ' + ("onclick='state.duplicate_context(" + i + ")'") + ' id="' + context_identifier + '_duplicate" class="btn btn-outline-primary mx-auto">Duplicate Context</button>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                    '            <button type="button" ' + ("onclick='state.delete_context(" + i + ")'") + ' id="' + context_identifier + '_delete" class="btn btn-outline-danger mx-auto">Delete Context</button>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '</h1>\n';
            }
            $("#algorithm_contexts").html(html);

            this.context_codemirrors = [];

            for (var i = 0; i < contexts.length; i++) {
                var context = contexts[i];
                var context_identifier = context.identifier;
                width_editor = CodeMirror.fromTextArea(document.getElementById(context_identifier + '_width_exact_js'), {
                    mode: "xml",
                    lineNumbers: false,
                    theme: "the-matrix",
                    autoRefresh: true,
                    lineWrapping: true
                });
                width_editor.getWrapperElement().id = context_identifier + '_width_exact_js_codemirror';
                width_editor.setValue(context.width.exact_value);
                this.context_codemirrors.push(width_editor);

                height_editor = CodeMirror.fromTextArea(document.getElementById(context_identifier + '_height_exact_js'), {
                    mode: "javascript",
                    lineNumbers: false,
                    theme: "the-matrix",
                    autoRefresh: true,
                    lineWrapping: true
                });
                height_editor.getWrapperElement().id = context_identifier + '_height_exact_js_codemirror';
                height_editor.setValue(context.height.exact_value);
                this.context_codemirrors.push(height_editor);

                this.mutex_checkboxes([context_identifier + '_width_screen_size',
                context_identifier + '_width_next_lowest_power_of_two',
                context_identifier + '_width_next_highest_power_of_two',
                context_identifier + '_width_exact'],
                    (function (context_identifier) {
                        return function () {
                            if ($("#" + context_identifier + '_width_exact').prop("checked"))
                                $("#" + context_identifier + "_width_exact_js_codemirror").show();
                            else
                                $("#" + context_identifier + "_width_exact_js_codemirror").hide();
                        }
                    })(context_identifier));

                this.mutex_checkboxes([context_identifier + '_height_screen_size',
                context_identifier + '_height_next_lowest_power_of_two',
                context_identifier + '_height_next_highest_power_of_two',
                context_identifier + '_height_exact'],
                    (function (context_identifier) {
                        return function () {
                            if ($("#" + context_identifier + '_height_exact').prop("checked"))
                                $("#" + context_identifier + "_height_exact_js_codemirror").show();
                            else
                                $("#" + context_identifier + "_height_exact_js_codemirror").hide();
                        }
                    })(context_identifier));

                if (context.width.type == OpenGLDimension.Type.SCREEN_SIZE)
                    $("#" + context_identifier + '_width_screen_size').prop("checked", true);
                if (context.width.type == OpenGLDimension.Type.NEXT_LOWEST_POWER_OF_TWO)
                    $("#" + context_identifier + '_width_next_lowest_power_of_two').prop("checked", true);
                if (context.width.type == OpenGLDimension.Type.NEXT_HIGHEST_POWER_OF_TWO)
                    $("#" + context_identifier + '_width_next_highest_power_of_two').prop("checked", true);
                if (context.width.type == OpenGLDimension.Type.EXACT)
                    $("#" + context_identifier + '_width_exact').prop("checked", true);

                if (context.height.type == OpenGLDimension.Type.SCREEN_SIZE)
                    $("#" + context_identifier + '_height_screen_size').prop("checked", true);
                if (context.height.type == OpenGLDimension.Type.NEXT_LOWEST_POWER_OF_TWO)
                    $("#" + context_identifier + '_height_next_lowest_power_of_two').prop("checked", true);
                if (context.height.type == OpenGLDimension.Type.NEXT_HIGHEST_POWER_OF_TWO)
                    $("#" + context_identifier + '_height_next_highest_power_of_two').prop("checked", true);
                if (context.height.type == OpenGLDimension.Type.EXACT)
                    $("#" + context_identifier + '_height_exact').prop("checked", true);

                if ($("#" + context_identifier + '_width_exact').prop("checked"))
                    $("#" + context_identifier + "_width_exact_js_codemirror").show();
                else
                    $("#" + context_identifier + "_width_exact_js_codemirror").hide();

                if ($("#" + context_identifier + '_height_exact').prop("checked"))
                    $("#" + context_identifier + "_height_exact_js_codemirror").show();
                else
                    $("#" + context_identifier + "_height_exact_js_codemirror").hide();
            }
        }

        GlobalState.prototype.get_ui_contexts = function () {
            var ui_contexts = [];
            for (var i = 0; i < this.pipeline.contexts.length; i++) {
                var context = this.pipeline.contexts[i];
                var context_identifier = context.identifier;
                console.log(context_identifier);
                var ui_context = JSON.parse(JSON.stringify(context));

                ui_context.name = $("#" + context_identifier + '_name').val();

                if ($("#" + context_identifier + '_depth_checkbox').prop("checked"))
                    ui_context.depth_test = true;
                else
                    ui_context.depth_test = false;

                if ($("#" + context_identifier + '_width_screen_size').prop("checked"))
                    ui_context.width.type = OpenGLDimension.Type.SCREEN_SIZE;
                else if ($("#" + context_identifier + '_width_next_lowest_power_of_two').prop("checked"))
                    ui_context.width.type = OpenGLDimension.Type.NEXT_LOWEST_POWER_OF_TWO;
                else if ($("#" + context_identifier + '_width_next_highest_power_of_two').prop("checked"))
                    ui_context.width.type = OpenGLDimension.Type.NEXT_HIGHEST_POWER_OF_TWO;
                else if ($("#" + context_identifier + '_width_exact').prop("checked"))
                    ui_context.width.type = OpenGLDimension.Type.EXACT;

                if ($("#" + context_identifier + '_height_screen_size').prop("checked"))
                    ui_context.height.type = OpenGLDimension.Type.SCREEN_SIZE;
                else if ($("#" + context_identifier + '_height_next_lowest_power_of_two').prop("checked"))
                    ui_context.height.type = OpenGLDimension.Type.NEXT_LOWEST_POWER_OF_TWO;
                else if ($("#" + context_identifier + '_height_next_highest_power_of_two').prop("checked"))
                    ui_context.height.type = OpenGLDimension.Type.NEXT_HIGHEST_POWER_OF_TWO;
                else if ($("#" + context_identifier + '_height_exact').prop("checked"))
                    ui_context.height.type = OpenGLDimension.Type.EXACT;

                ui_context.width.exact_value = this.context_codemirrors[i * 2 + 0].getValue()
                ui_context.height.exact_value = this.context_codemirrors[i * 2 + 1].getValue()

                ui_contexts.push(ui_context);
            }
            return ui_contexts;
        }


        GlobalState.prototype.add_context = function (new_context = default_algorithm_context) {
            new_context = JSON.parse(JSON.stringify(new_context));

            var ui_contexts = this.get_ui_contexts();

            ui_contexts.push(new_context);
            this.pipeline.contexts.push(new_context);
            this.render_contexts(ui_contexts);
        }

        GlobalState.prototype.delete_context = function (index) {
            var ui_contexts = this.get_ui_contexts();

            ui_contexts.splice(index, 1);
            this.pipeline.contexts.splice(index, 1);
            this.render_contexts(ui_contexts);
        }

        GlobalState.prototype.duplicate_context = function (index) {
            var ui_contexts = this.get_ui_contexts();
            new_context = JSON.parse(JSON.stringify(ui_contexts[index]));

            ui_contexts.push(new_context);
            this.pipeline.contexts.push(new_context);
            this.render_contexts(ui_contexts);
        }
        GlobalState.prototype.move_context_up = function (index) {
            var ui_contexts = this.get_ui_contexts();

            var new_contexts = [];

            new_contexts = new_contexts.concat(ui_contexts.splice(0, index - 1));
            var moving_context = ui_contexts.splice(0, 1);
            new_contexts = new_contexts.concat(ui_contexts.splice(0, 1));
            new_contexts = new_contexts.concat(moving_context);
            new_contexts = new_contexts.concat(ui_contexts);

            this.pipeline.contexts = new_contexts;
            this.render_contexts(new_contexts);
        }
        GlobalState.prototype.move_context_down = function (index) {
            var ui_contexts = this.get_ui_contexts();

            var new_contexts = [];

            new_contexts = new_contexts.concat(ui_contexts.splice(0, index));
            var moving_context = ui_contexts.splice(0, 1);
            new_contexts = new_contexts.concat(ui_contexts.splice(0, 1));
            new_contexts = new_contexts.concat(moving_context);
            new_contexts = new_contexts.concat(ui_contexts);

            this.pipeline.contexts = new_contexts;
            this.render_contexts(new_contexts);
        }

        GlobalState.prototype.render_programs = function (programs) {
            var html = "";
            for (var i = 0; i < programs.length; i++) {
                var program = programs[i];

                if (!window.program_counter)
                    window.program_counter = 0;
                var new_program_index = window.program_counter++;

                var name_prefix = "program_identifier_";
                var program_identifier = name_prefix + new_program_index;
                this.pipeline.programs[i].identifier = program_identifier;
                program.identifier = program_identifier;

                html += '<h1 class="editable" id="' + program_identifier + '" \n' +
                    'style="padding-top: 14px; padding-bottom: 14px;text-align:center; color:#fff; font-size: 14px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">\n' +
                    '   <div class="row">\n' +
                    '        <div class="col-12 col-sm-12 col-md-6 col-lg-6" style="align-self: center;">\n' +
                    '            <a>Program Identifier:</a>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '        <div class="col-12 col-sm-12 col-md-6 col-lg-6">\n' +
                    '            <input id="' + program_identifier + '_name" style="text-align:center; color:#fff;" placeholder="Program name..."\n' +
                    '                value="'+program.name+'"></input>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                    '            <br>\n' +
                    '            <a>Uniform Variables:</a>\n' +
                    '        </div>\n' +
                    '    </div>\n';
                for (var j = 0; j < program.uniforms.length; j++) {
                    if (!window.uniform_counter)
                        window.uniform_counter = 0;
                    var new_uniform_index = window.uniform_counter++;
                    var uniform = program.uniforms[j];
                    var uniform_identifier = program_identifier + "_uniform_" + new_uniform_index;
                    this.pipeline.programs[i].uniforms[j].identifier = uniform_identifier;
                    uniform.identifier = uniform_identifier;
                    html += '    <div id="' + uniform_identifier + '" \n' +
                        '        style="margin:14px; padding-top: 14px; padding-bottom: 14px;text-align:center; color:#fff; font-size: 14px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">\n' +
                        '\n' +
                        '        <div class="row">\n' +
                        '            <div class="col-12 col-sm-12 col-md-6 col-lg-6" style="align-self: center;">\n' +
                        '                <a>Uniform Identifier:</a>\n' +
                        '                <br>\n' +
                        '                <br>\n' +
                        '            </div>\n' +
                        '            <div class="col-12 col-sm-12 col-md-6 col-lg-6">\n' +
                        '                <input id="' + uniform_identifier + '_name" style="text-align:center; color:#fff;" placeholder="uniform name..."\n' +
                        '                    value="'+uniform.name+'"></input>\n' +
                        '                <br>\n' +
                        '                <br>\n' +
                        '\n' +
                        '            </div>\n' +
                        '        </div>\n' +
                        '        <br>\n' +
                        '        <div class="row">\n' +
                        '            <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                        '                <a>Uniform Type:</a>\n' +
                        '                <br>\n' +
                        '                <br>\n' +
                        '            </div>\n' +
                        '        </div>\n' +
                        '        <div class="row" style="text-align: right;">\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>float</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_float" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_float"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>int</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_int" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_int"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>bool</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_bool" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>vec2</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_vec2" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_vec2"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>vec3</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_vec3" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_vec3"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>vec4</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_vec4" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_vec4"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>ivec2</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_ivec2" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_ivec2"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>ivec3</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_ivec3" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_ivec3"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>ivec4</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_ivec4" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_ivec4"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>bvec2</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_bvec2" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_bvec2"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>bvec3</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_bvec3" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_bvec3"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>bvec4</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_bvec4" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_bvec4"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>mat2</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_mat2" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_mat2"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>mat3</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_mat3" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_mat3"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>mat4</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_mat4" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_mat4"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>sampler2d</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_sampler2d" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_sampler2d"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2" style="align-self: flex-end; text-align: right">\n' +
                        '                <a>samplercube</a>\n' +
                        '            </div>\n' +
                        '            <div class="col-6 col-sm-2 col-md-2 col-lg-2">\n' +
                        '                <div class="checkbox">\n' +
                        '                    <input style="float:right;" id="' + uniform_identifier + '_type_samplercube" type="checkbox" value="">\n' +
                        '                    <label for="' + uniform_identifier + '_type_samplercube"></label>\n' +
                        '                </div>\n' +
                        '            </div>\n' +
                        '        </div>\n' +
                        '        <br>\n' +
                        '        <div class="row">\n' +
                        '            <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                        '                <a>Uniform Value:</a>\n' +
                        '                <br>\n' +
                        '                <br>\n' +
                        '            </div>\n' +
                        '        </div>\n' +
                        '        <div class="row">\n' +
                        '            <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                        '                <textarea id="' + uniform_identifier + '_js_code" rows="8"\n' +
                        '                    style="text-align:left; border: 1px solid #FFF;"\n' +
                        '                    placeholder="Enter JavaScript here..." value=""></textarea>\n' +
                        '            </div>\n' +
                        '            <br>\n' +
                        '        </div>\n' +
                        '        <br>\n' +
                        '    <div class="row">\n' +
                        '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                        '            <button type="button" ' + (j == 0 ? "disabled" : "onclick='state.move_uniform_up(" + i + ", " + j + ")'") + ' id="' + uniform_identifier + '_move_up" class="btn btn-outline-warning mx-auto">Move Uniform Up</button>\n' +
                        '            <br>\n' +
                        '        </div>\n' +
                        '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                        '            <button type="button" ' + (j == program.uniforms.length - 1 ? "disabled" : "onclick='state.move_uniform_down(" + i + ", " + j + ")'") + ' id="' + uniform_identifier + '_move_down" class="btn btn-outline-warning mx-auto">Move Uniform Down</button>\n' +
                        '            <br>\n' +
                        '        </div>\n' +
                        '    </div>\n' +
                        '    <br>\n' +
                        '\n' +
                        '\n' +
                        '    <div class="row">\n' +
                        '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                        '            <button type="button" ' + ("onclick='state.duplicate_uniform(" + i + ", " + j + ")'") + ' id="' + uniform_identifier + '_duplicate" class="btn btn-outline-primary mx-auto">Duplicate Uniform</button>\n' +
                        '            <br>\n' +
                        '        </div>\n' +
                        '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                        '            <button type="button" ' + ("onclick='state.delete_uniform(" + i + ", " + j + ")'") + ' id="' + uniform_identifier + '_delete" class="btn btn-outline-danger mx-auto">Delete Uniform</button>\n' +
                        '            <br>\n' +
                        '        </div>\n' +
                        '    </div>\n' +
                        '    </div>\n' +
                        '        <br>\n';
                }
                html += '        <div class="row">\n' +
                    '            <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                    '                <button onclick="state.add_uniform(' + i + ')" type="button" class="btn btn-outline-success mx-auto">Add Uniform\n' +
                    '                    Variable</button>\n' +
                    '                <br>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                    '            <a>Vertex Shader</a>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                    '            <textarea id="' + program_identifier + '_vert_code" rows="8" style="text-align:left; border: 1px solid #FFF;"\n' +
                    '                placeholder="Enter JavaScript here..."\n' +
                    '                value=""></textarea>\n' +
                    '        </div>\n' +
                    '        <br>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                    '            <a>Fragment Shader:</a>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                    '            <textarea id="' + program_identifier + '_frag_code" rows="8" style="text-align:left; border: 1px solid #FFF;"\n' +
                    '                placeholder="Enter JavaScript here..."\n' +
                    '                value=""></textarea>\n' +
                    '        </div>\n' +
                    '        <br>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '\n' +
                    '\n' +
                    '\n' +
                    '\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                    '            <button type="button" ' + (i == 0 ? "disabled" : "onclick='state.move_program_up(" + i + ")'") + ' id="' + program_identifier + '_move_up" class="btn btn-outline-warning mx-auto">Move Program Up</button>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                    '            <button type="button" ' + (i == programs.length - 1 ? "disabled" : "onclick='state.move_program_down(" + i + ")'") + ' id="' + program_identifier + '_move_down" class="btn btn-outline-warning mx-auto">Move Program Down</button>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '\n' +
                    '\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                    '            <button type="button" ' + ("onclick='state.duplicate_program(" + i + ")'") + ' id="' + program_identifier + '_duplicate" class="btn btn-outline-primary mx-auto">Duplicate Program</button>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                    '            <button type="button" ' + ("onclick='state.delete_program(" + i + ")'") + ' id="' + program_identifier + '_delete" class="btn btn-outline-danger mx-auto">Delete Program</button>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '</h1>';
            }
            $("#algorithm_programs").html(html);

            this.program_codemirrors = [];

            for (var i = 0; i < programs.length; i++) {
                var program = programs[i];
                var program_identifier = program.identifier;

                this.program_codemirrors.push([]);

                frag_editor = CodeMirror.fromTextArea(document.getElementById(program_identifier + '_frag_code'), {
                    lineNumbers: false,
                    theme: "the-matrix",
                    autoRefresh: true,
                    lineWrapping: true
                });
                frag_editor.getWrapperElement().id = program_identifier + '_frag_code_codemirror';
                frag_editor.setValue(program.frag_code);
                this.program_codemirrors[i].push(frag_editor);

                vert_editor = CodeMirror.fromTextArea(document.getElementById(program_identifier + '_vert_code'), {
                    lineNumbers: false,
                    theme: "the-matrix",
                    autoRefresh: true,
                    lineWrapping: true
                });
                vert_editor.getWrapperElement().id = program_identifier + '_vert_code_codemirror';
                vert_editor.setValue(program.vert_code);
                this.program_codemirrors[i].push(vert_editor);

                for (var j = 0; j < program.uniforms.length; j++) {
                    var uniform = program.uniforms[j];
                    var uniform_identifier = uniform.identifier;

                    this.mutex_checkboxes([uniform_identifier + '_type_float',
                    uniform_identifier + '_type_int',
                    uniform_identifier + '_type_bool',
                    uniform_identifier + '_type_vec2',
                    uniform_identifier + '_type_vec3',
                    uniform_identifier + '_type_vec4',
                    uniform_identifier + '_type_ivec2',
                    uniform_identifier + '_type_ivec3',
                    uniform_identifier + '_type_ivec4',
                    uniform_identifier + '_type_bvec2',
                    uniform_identifier + '_type_bvec3',
                    uniform_identifier + '_type_bvec4',
                    uniform_identifier + '_type_mat2',
                    uniform_identifier + '_type_mat3',
                    uniform_identifier + '_type_mat4',
                    uniform_identifier + '_type_sampler2d',
                    uniform_identifier + '_type_samplercube'], null);

                    if (uniform.type == OpenGLUniform.Type.FLOAT)
                        $("#" + uniform_identifier + '_type_float').prop("checked", true);
                    if (uniform.type == OpenGLUniform.Type.INT)
                        $("#" + uniform_identifier + '_type_int').prop("checked", true);
                    if (uniform.type == OpenGLUniform.Type.BOOL)
                        $("#" + uniform_identifier + '_type_bool').prop("checked", true);
                    if (uniform.type == OpenGLUniform.Type.VEC_TWO)
                        $("#" + uniform_identifier + '_type_vec2').prop("checked", true);
                    if (uniform.type == OpenGLUniform.Type.VEC_THREE)
                        $("#" + uniform_identifier + '_type_vec3').prop("checked", true);
                    if (uniform.type == OpenGLUniform.Type.VEC_FOUR)
                        $("#" + uniform_identifier + '_type_vec4').prop("checked", true);
                    if (uniform.type == OpenGLUniform.Type.IVEC_TWO)
                        $("#" + uniform_identifier + '_type_ivec2').prop("checked", true);
                    if (uniform.type == OpenGLUniform.Type.IVEC_THREE)
                        $("#" + uniform_identifier + '_type_ivec3').prop("checked", true);
                    if (uniform.type == OpenGLUniform.Type.IVEC_FOUR)
                        $("#" + uniform_identifier + '_type_ivec4').prop("checked", true);
                    if (uniform.type == OpenGLUniform.Type.BVEC_TWO)
                        $("#" + uniform_identifier + '_type_bvec2').prop("checked", true);
                    if (uniform.type == OpenGLUniform.Type.BVEC_THREE)
                        $("#" + uniform_identifier + '_type_bvec3').prop("checked", true);
                    if (uniform.type == OpenGLUniform.Type.BVEC_FOUR)
                        $("#" + uniform_identifier + '_type_bvec4').prop("checked", true);
                    if (uniform.type == OpenGLUniform.Type.MAT_TWO)
                        $("#" + uniform_identifier + '_type_mat2').prop("checked", true);
                    if (uniform.type == OpenGLUniform.Type.MAT_THREE)
                        $("#" + uniform_identifier + '_type_mat3').prop("checked", true);
                    if (uniform.type == OpenGLUniform.Type.MAT_FOUR)
                        $("#" + uniform_identifier + '_type_mat4').prop("checked", true);
                    if (uniform.type == OpenGLUniform.Type.SAMPLER_TWO_D)
                        $("#" + uniform_identifier + '_type_sampler2d').prop("checked", true);
                    if (uniform.type == OpenGLUniform.Type.SAMPLERCUBE)
                        $("#" + uniform_identifier + '_type_samplercube').prop("checked", true);

                    uniform_js_editor = CodeMirror.fromTextArea(document.getElementById(uniform_identifier + '_js_code'), {
                        mode: "javascript",
                        lineNumbers: false,
                        theme: "the-matrix",
                        autoRefresh: true,
                        lineWrapping: true
                    });
                    uniform_js_editor.getWrapperElement().id = uniform_identifier + '_js_code_codemirror';
                    uniform_js_editor.setValue(uniform.value);
                    this.program_codemirrors[i].push(uniform_js_editor);
                }
            }
        }

        GlobalState.prototype.get_ui_programs = function () {
            var ui_programs = [];
            for (var i = 0; i < this.pipeline.programs.length; i++) {
                var program = this.pipeline.programs[i];
                var program_identifier = program.identifier;
                console.log(program_identifier);
                var ui_program = JSON.parse(JSON.stringify(program));

                ui_program.name = $("#" + program_identifier + '_name').val();

                ui_program.frag_code = this.program_codemirrors[i][0].getValue()
                ui_program.vert_code = this.program_codemirrors[i][1].getValue()

                ui_program.uniforms = this.get_ui_uniforms(i);

                ui_programs.push(ui_program);
            }
            return ui_programs;
        }


        GlobalState.prototype.add_program = function (new_program = default_algorithm_program) {
            new_program = JSON.parse(JSON.stringify(new_program));

            var ui_programs = this.get_ui_programs();

            ui_programs.push(new_program);
            this.pipeline.programs.push(new_program);
            this.render_programs(ui_programs);
        }

        GlobalState.prototype.delete_program = function (index) {
            var ui_programs = this.get_ui_programs();

            ui_programs.splice(index, 1);
            this.pipeline.programs.splice(index, 1);
            this.render_programs(ui_programs);
        }

        GlobalState.prototype.duplicate_program = function (index) {
            var ui_programs = this.get_ui_programs();
            new_program = JSON.parse(JSON.stringify(ui_programs[index]));

            ui_programs.push(new_program);
            this.pipeline.programs.push(new_program);
            this.render_programs(ui_programs);
        }
        GlobalState.prototype.move_program_up = function (index) {
            var ui_programs = this.get_ui_programs();

            var new_programs = [];

            new_programs = new_programs.concat(ui_programs.splice(0, index - 1));
            var moving_program = ui_programs.splice(0, 1);
            new_programs = new_programs.concat(ui_programs.splice(0, 1));
            new_programs = new_programs.concat(moving_program);
            new_programs = new_programs.concat(ui_programs);

            this.pipeline.programs = new_programs;
            this.render_programs(new_programs);
        }
        GlobalState.prototype.move_program_down = function (index) {
            var ui_programs = this.get_ui_programs();

            var new_programs = [];

            new_programs = new_programs.concat(ui_programs.splice(0, index));
            var moving_program = ui_programs.splice(0, 1);
            new_programs = new_programs.concat(ui_programs.splice(0, 1));
            new_programs = new_programs.concat(moving_program);
            new_programs = new_programs.concat(ui_programs);

            this.pipeline.programs = new_programs;
            this.render_programs(new_programs);
        }


        GlobalState.prototype.get_ui_uniforms = function (program_index) {
            var program = this.pipeline.programs[program_index];
            var program_uniforms = [];
            for (var j = 0; j < program.uniforms.length; j++) {
                var uniform = program.uniforms[j];
                var uniform_identifier = uniform.identifier;
                uniform.name = $("#" + uniform_identifier + '_name').val();

                if ($("#" + uniform_identifier + '_type_float').prop("checked"))
                    uniform.type = OpenGLUniform.Type.FLOAT;
                if ($("#" + uniform_identifier + '_type_int').prop("checked"))
                    uniform.type = OpenGLUniform.Type.INT;
                if ($("#" + uniform_identifier + '_type_bool').prop("checked"))
                    uniform.type = OpenGLUniform.Type.BOOL;
                if ($("#" + uniform_identifier + '_type_vec2').prop("checked"))
                    uniform.type = OpenGLUniform.Type.VEC_TWO;
                if ($("#" + uniform_identifier + '_type_vec3').prop("checked"))
                    uniform.type = OpenGLUniform.Type.VEC_THREE;
                if ($("#" + uniform_identifier + '_type_vec4').prop("checked"))
                    uniform.type = OpenGLUniform.Type.VEC_FOUR;
                if ($("#" + uniform_identifier + '_type_ivec2').prop("checked"))
                    uniform.type = OpenGLUniform.Type.IVEC_TWO;
                if ($("#" + uniform_identifier + '_type_ivec3').prop("checked"))
                    uniform.type = OpenGLUniform.Type.IVEC_THREE;
                if ($("#" + uniform_identifier + '_type_ivec4').prop("checked"))
                    uniform.type = OpenGLUniform.Type.IVEC_FOUR;
                if ($("#" + uniform_identifier + '_type_bvec2').prop("checked"))
                    uniform.type = OpenGLUniform.Type.BVEC_TWO;
                if ($("#" + uniform_identifier + '_type_bvec3').prop("checked"))
                    uniform.type = OpenGLUniform.Type.BVEC_THREE;
                if ($("#" + uniform_identifier + '_type_bvec4').prop("checked"))
                    uniform.type = OpenGLUniform.Type.BVEC_FOUR;
                if ($("#" + uniform_identifier + '_type_mat2').prop("checked"))
                    uniform.type = OpenGLUniform.Type.MAT_TWO;
                if ($("#" + uniform_identifier + '_type_mat3').prop("checked"))
                    uniform.type = OpenGLUniform.Type.MAT_THREE;
                if ($("#" + uniform_identifier + '_type_mat4').prop("checked"))
                    uniform.type = OpenGLUniform.Type.MAT_FOUR;
                if ($("#" + uniform_identifier + '_type_sampler2d').prop("checked"))
                    uniform.type = OpenGLUniform.Type.SAMPLER_TWO_D;
                if ($("#" + uniform_identifier + '_type_samplercube').prop("checked"))
                    uniform.type = OpenGLUniform.Type.SAMPLERCUBE;

                uniform.value = this.program_codemirrors[program_index][j + 2].getValue()
                program_uniforms.push(uniform);
            }
            return program_uniforms;
        }

        GlobalState.prototype.add_uniform = function (program_index, new_uniform = default_algorithm_uniform) {
            new_uniform = JSON.parse(JSON.stringify(new_uniform));

            var ui_programs = this.get_ui_programs();

            ui_programs[program_index].uniforms.push(new_uniform);
            this.pipeline.programs[program_index].uniforms.push(new_uniform)
            this.render_programs(ui_programs);
        }

        GlobalState.prototype.delete_uniform = function (program_index, uniform_index) {
            var ui_programs = this.get_ui_programs();

            ui_programs[program_index].uniforms.splice(uniform_index, 1);
            this.pipeline.programs[program_index].uniforms.splice(uniform_index, 1);
            this.render_programs(ui_programs);
        }

        GlobalState.prototype.duplicate_uniform = function (program_index, uniform_index) {
            var ui_programs = this.get_ui_programs();
            new_uniform = JSON.parse(JSON.stringify(ui_programs[program_index].uniforms[uniform_index]));

            ui_programs[program_index].uniforms.push(new_uniform);
            this.pipeline.programs[program_index].uniforms.push(new_uniform)
            this.render_programs(ui_programs);
        }
        GlobalState.prototype.move_uniform_up = function (program_index, uniform_index) {
            var ui_programs = this.get_ui_programs();

            var new_uniforms = [];

            new_uniforms = new_uniforms.concat(ui_programs[program_index].uniforms.splice(0, uniform_index - 1));
            var moving_uniform = ui_programs[program_index].uniforms.splice(0, 1);
            new_uniforms = new_uniforms.concat(ui_programs[program_index].uniforms.splice(0, 1));
            new_uniforms = new_uniforms.concat(moving_uniform);
            new_uniforms = new_uniforms.concat(ui_programs[program_index].uniforms);

            ui_programs[program_index].uniforms = new_uniforms;
            this.pipeline.programs[program_index].uniforms = new_uniforms;
            this.render_programs(ui_programs);
        }
        GlobalState.prototype.move_uniform_down = function (program_index, uniform_index) {
            var ui_programs = this.get_ui_programs();

            var new_uniforms = [];

            new_uniforms = new_uniforms.concat(ui_programs[program_index].uniforms.splice(0, uniform_index));
            var moving_uniform = ui_programs[program_index].uniforms.splice(0, 1);
            new_uniforms = new_uniforms.concat(ui_programs[program_index].uniforms.splice(0, 1));
            new_uniforms = new_uniforms.concat(moving_uniform);
            new_uniforms = new_uniforms.concat(ui_programs[program_index].uniforms);

            ui_programs[program_index].uniforms = new_uniforms;
            this.pipeline.programs[program_index].uniforms = new_uniforms;
            this.render_programs(ui_programs);
        }

        GlobalState.prototype.get_ui_algorithm = function () {
        }

        GlobalState.prototype.set_ui_algorithm = function (algorithm) {
            $("#algorithm_name").val(algorithm.name);
            $("#algorithm_description").val(algorithm.description);
            
            if(algorithm.public)
                $("#public_checkbox").prop("checked", true);
            else
                $("#public_checkbox").prop("checked", false);
                
            if(algorithm.state.has_html)
            {
                $("#html_checkbox").prop("checked", true);
                $("#algorithm_html").show();
                window.html_editor.setValue(algorithm.html)
            }
            else
            {
                $("#algorithm_html").hide();
            }

            if(algorithm.state.has_client)
            {
                $("#javascript_checkbox").prop("checked", true);
                $("#algorithm_javascript").show();
                window.javascript_editor.setValue(algorithm.client)
            }
            else
            {
                $("#algorithm_javascript").hide();
            }
            
            this.pipeline.contexts = [];
            this.pipeline.programs = [];
            this.pipeline.stages = [];

            for (var i = 0; i < algorithm.pipeline.contexts.length; i++)
                this.add_context(algorithm.pipeline.contexts[i]);
            for (var i = 0; i < algorithm.pipeline.programs.length; i++)
                this.add_program(algorithm.pipeline.programs[i]);
            for (var i = 0; i < algorithm.pipeline.stages.length; i++)
                this.add_stage(algorithm.pipeline.stages[i]);
        }

        window.onpopstate = function (event) {
            console.log(event);
            state.pop_page(event)
        };

        var on_resources_loaded = function () {
            console.log($)//Show me the money
            if (typeof $ == 'undefined' ||
                typeof $('[data-toggle="tooltip"]') == 'undefined' ||
                typeof $('[data-toggle="tooltip"]').tooltip == 'undefined' ||
                !protobuf)
                window.setTimeout(on_resources_loaded, 1000);
            else {
                $('[data-toggle="tooltip"]').tooltip();
                state = new GlobalState();
                state.wait_for_proto_and_connect()
            }
        }


        GlobalState.prototype.render_stages = function (stages) {
            var html = "";
            for (var i = 0; i < stages.length; i++) {
                var stage = stages[i];

                if (!window.stage_counter)
                    window.stage_counter = 0;
                var new_stage_index = window.stage_counter++;

                var name_prefix = "stage_identifier_";
                var stage_identifier = name_prefix + new_stage_index;
                this.pipeline.stages[i].identifier = stage_identifier;
                stage.identifier = stage_identifier;

                html += '<h1 class="editable" id="' + stage_identifier + '"\n' +
                    '    style="padding-top: 14px; padding-bottom: 14px;text-align:center; color:#fff; font-size: 14px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;">\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-12 col-sm-12 col-md-6 col-lg-6" style="align-self: center;">\n' +
                    '            <a>Stage Identifier:</a>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '        <div class="col-12 col-sm-12 col-md-6 col-lg-6">\n' +
                    '            <input id="' + stage_identifier + '_name" style="text-align:center; color:#fff;" placeholder="Program name..."\n' +
                    '                value=""></input>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-12 col-sm-12 col-md-6 col-lg-6" style="align-self: center;">\n' +
                    '            <a>Lined Context Identifier:</a>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '        <div class="col-12 col-sm-12 col-md-6 col-lg-6">\n' +
                    '            <input style="text-align:center; color:#fff;" placeholder="Context name..."\n' +
                    '                id="' + stage_identifier + '_context_name" value=""></input>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-12 col-sm-12 col-md-6 col-lg-6" style="align-self: center;">\n' +
                    '            <a>Lined Program Identifier:</a>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '        <div class="col-12 col-sm-12 col-md-6 col-lg-6">\n' +
                    '            <input style="text-align:center; color:#fff;" placeholder="Program name..."\n' +
                    '                id="' + stage_identifier + '_program_name" value=""></input>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row" style="border-top: 1px solid #fff;">\n' +
                    '        <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                    '            <br>\n' +
                    '            <a>Stage Type:</a>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right;">\n' +
                    '            <a>Shader</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + stage_identifier + '_stage_shader" type="checkbox" value="">\n' +
                    '                <label for="' + stage_identifier + '_stage_shader"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>Points</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + stage_identifier + '_stage_mesh_points" type="checkbox" value="">\n' +
                    '                <label for="' + stage_identifier + '_stage_mesh_points"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>Lines</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + stage_identifier + '_stage_mesh_lines" type="checkbox" value="">\n' +
                    '                <label for="' + stage_identifier + '_stage_mesh_lines"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>Line Strip</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + stage_identifier + '_stage_mesh_line_strip" type="checkbox" value="">\n' +
                    '                <label for="' + stage_identifier + '_stage_mesh_line_strip"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>Line Loop</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + stage_identifier + '_stage_mesh_line_loop" type="checkbox" value="">\n' +
                    '                <label for="' + stage_identifier + '_stage_mesh_line_loop"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>Triangles</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + stage_identifier + '_stage_mesh_triangles" type="checkbox" value="">\n' +
                    '                <label for="' + stage_identifier + '_stage_mesh_triangles"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>Triangle Fan</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + stage_identifier + '_stage_mesh_triangle_fan" type="checkbox" value="">\n' +
                    '                <label for="' + stage_identifier + '_stage_mesh_triangle_fan"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6" style="align-self: flex-end; text-align: right">\n' +
                    '            <a>Triangle Strip</a>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: left;">\n' +
                    '            <div class="checkbox">\n' +
                    '                <input style="float:right;" id="' + stage_identifier + '_stage_mesh_triangle_strip" type="checkbox" value="">\n' +
                    '                <label for="' + stage_identifier + '_stage_mesh_triangle_strip"></label>\n' +
                    '            </div>\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '        <div class="col-2 col-sm-2 col-md-2 col-lg-2" style="text-align: center;">\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row" id="' + stage_identifier + '_indices_section">\n' +
                    '        <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                    '            <a>Mesh Indices Evaluation:</a>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '            <textarea id="' + stage_identifier + '_indices_code" rows="8" style="text-align:left; border: 1px solid #FFF;"\n' +
                    '                placeholder="Enter JavaScript here..."\n' +
                    '                value=""></textarea>\n' +
                    '        </div>\n' +
                    '        <br>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '    <div class="row" id="' + stage_identifier + '_vertices_section">\n' +
                    '        <div class="col-12 col-sm-12 col-md-12 col-lg-12">\n' +
                    '            <a>Mesh Vertices Evaluation:</a>\n' +
                    '            <br>\n' +
                    '            <br>\n' +
                    '            <textarea id="' + stage_identifier + '_vertices_code" rows="8" style="text-align:left; border: 1px solid #FFF;"\n' +
                    '                placeholder="Enter JavaScript here..."\n' +
                    '                value=""></textarea>\n' +
                    '        </div>\n' +
                    '        <br>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                    '            <button type="button" ' + (i == 0 ? "disabled" : "onclick='state.move_stage_up(" + i + ")'") + ' id="' + stage_identifier + '_move_up" class="btn btn-outline-warning mx-auto">Move Stage Up</button>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                    '            <button type="button" ' + (i == stages.length - 1 ? "disabled" : "onclick='state.move_stage_down(" + i + ")'") + ' id="' + stage_identifier + '_move_down" class="btn btn-outline-warning mx-auto">Move Stage Down</button>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '    <br>\n' +
                    '\n' +
                    '\n' +
                    '    <div class="row">\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                    '            <button type="button" ' + ("onclick='state.duplicate_stage(" + i + ")'") + ' id="' + stage_identifier + '_duplicate" class="btn btn-outline-primary mx-auto">Duplicate Stage</button>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '        <div class="col-6 col-sm-6 col-md-6 col-lg-6">\n' +
                    '            <button type="button" ' + ("onclick='state.delete_stage(" + i + ")'") + ' id="' + stage_identifier + '_delete" class="btn btn-outline-danger mx-auto">Delete Stage</button>\n' +
                    '            <br>\n' +
                    '        </div>\n' +
                    '    </div>\n' +
                    '</h1>';
            }
            $("#algorithm_stages").html(html);

            this.stage_codemirrors = [];

            for (var i = 0; i < stages.length; i++) {
                var stage = stages[i];
                var stage_identifier = stage.identifier;

                this.stage_codemirrors.push([]);

                this.mutex_checkboxes([stage_identifier + '_stage_shader',
                stage_identifier + '_stage_mesh_points',
                stage_identifier + '_stage_mesh_lines',
                stage_identifier + '_stage_mesh_line_strip',
                stage_identifier + '_stage_mesh_line_loop',
                stage_identifier + '_stage_mesh_triangles',
                stage_identifier + '_stage_mesh_triangle_fan',
                stage_identifier + '_stage_mesh_triangle_strip'],
                    (function (stage_identifier) {
                        return function () {
                            if ($("#" + stage_identifier + '_stage_shader').prop("checked")) {
                                $("#" + stage_identifier + "_indices_section").hide();
                                $("#" + stage_identifier + "_vertices_section").hide();
                            }
                            else {
                                $("#" + stage_identifier + "_indices_section").show();
                                $("#" + stage_identifier + "_vertices_section").show();
                            }
                        }
                    })(stage_identifier));

                indices_editor = CodeMirror.fromTextArea(document.getElementById(stage_identifier + '_indices_code'), {
                    mode: "xml",
                    lineNumbers: false,
                    theme: "the-matrix",
                    autoRefresh: true,
                    lineWrapping: true
                });
                indices_editor.getWrapperElement().id = stage_identifier + '_indices_code_codemirror';
                indices_editor.setValue(stage.mesh_indices_eval ? stage.mesh_indices_eval : "");
                this.stage_codemirrors[i].push(indices_editor);

                vertices_editor = CodeMirror.fromTextArea(document.getElementById(stage_identifier + '_vertices_code'), {
                    mode: "xml",
                    lineNumbers: false,
                    theme: "the-matrix",
                    autoRefresh: true,
                    lineWrapping: true
                });
                vertices_editor.getWrapperElement().id = stage_identifier + '_vertices_code_codemirror';
                vertices_editor.setValue(stage.mesh_vertices_eval ? stage.mesh_vertices_eval : "");
                this.stage_codemirrors[i].push(vertices_editor);


                if (stage.type == OpenGLStage.Type.SHADER) {
                    $("#" + stage_identifier + '_stage_shader').prop("checked", true);
                    $("#" + stage_identifier + '_indices_section').hide();
                    $("#" + stage_identifier + '_vertices_section').hide();

                }
                else {
                    $("#" + stage_identifier + '_indices_section').show();
                    $("#" + stage_identifier + '_vertices_section').show();
                }
                if (stage.type == OpenGLStage.Type.MESH_POINTS)
                    $("#" + stage_identifier + '_stage_mesh_points').prop("checked", true);
                if (stage.type == OpenGLStage.Type.MESH_LINES)
                    $("#" + stage_identifier + '_stage_mesh_lines').prop("checked", true);
                if (stage.type == OpenGLStage.Type.MESH_LINE_STRIP)
                    $("#" + stage_identifier + '_stage_mesh_line_strip').prop("checked", true);
                if (stage.type == OpenGLStage.Type.MESH_LINE_LOOP)
                    $("#" + stage_identifier + '_stage_mesh_line_loop').prop("checked", true);
                if (stage.type == OpenGLStage.Type.MESH_TRIANGLES)
                    $("#" + stage_identifier + '_stage_mesh_triangles').prop("checked", true);
                if (stage.type == OpenGLStage.Type.MESH_TRIANGLE_FAN)
                    $("#" + stage_identifier + '_stage_mesh_triangle_fan').prop("checked", true);
                if (stage.type == OpenGLStage.Type.MESH_TRIANGLE_STRIP)
                    $("#" + stage_identifier + '_stage_mesh_triangle_strip').prop("checked", true);
            }
        }
        GlobalState.prototype.get_ui_stages = function () {
            var ui_stages = [];
            for (var i = 0; i < this.pipeline.stages.length; i++) {
                var stage = this.pipeline.stages[i];
                var stage_identifier = stage.identifier;
                console.log(stage_identifier);
                var ui_stage = JSON.parse(JSON.stringify(stage));

                ui_stage.name = $("#" + stage_identifier + '_name').val();

                ui_stage.mesh_indices_eval = this.stage_codemirrors[i][0].getValue()
                ui_stage.mesh_vertices_eval = this.stage_codemirrors[i][1].getValue()

                ui_stages.push(ui_stage);
            }
            return ui_stages;
        }


        GlobalState.prototype.add_stage = function (new_stage = default_algorithm_stage) {
            new_stage = JSON.parse(JSON.stringify(new_stage));

            var ui_stages = this.get_ui_stages();

            ui_stages.push(new_stage);
            this.pipeline.stages.push(new_stage);
            this.render_stages(ui_stages);
        }

        GlobalState.prototype.delete_stage = function (index) {
            var ui_stages = this.get_ui_stages();

            ui_stages.splice(index, 1);
            this.pipeline.stages.splice(index, 1);
            this.render_stages(ui_stages);
        }

        GlobalState.prototype.duplicate_stage = function (index) {
            var ui_stages = this.get_ui_stages();
            new_stage = JSON.parse(JSON.stringify(ui_stages[index]));

            ui_stages.push(new_stage);
            this.pipeline.stages.push(new_stage);
            this.render_stages(ui_stages);
        }
        GlobalState.prototype.move_stage_up = function (index) {
            var ui_stages = this.get_ui_stages();

            var new_stages = [];

            new_stages = new_stages.concat(ui_stages.splice(0, index - 1));
            var moving_stage = ui_stages.splice(0, 1);
            new_stages = new_stages.concat(ui_stages.splice(0, 1));
            new_stages = new_stages.concat(moving_stage);
            new_stages = new_stages.concat(ui_stages);

            this.pipeline.stages = new_stages;
            this.render_stages(new_stages);
        }
        GlobalState.prototype.move_stage_down = function (index) {
            var ui_stages = this.get_ui_stages();

            var new_stages = [];

            new_stages = new_stages.concat(ui_stages.splice(0, index));
            var moving_stage = ui_stages.splice(0, 1);
            new_stages = new_stages.concat(ui_stages.splice(0, 1));
            new_stages = new_stages.concat(moving_stage);
            new_stages = new_stages.concat(ui_stages);

            this.pipeline.stages = new_stages;
            this.render_stages(new_programs);
        }


        window.onload = function () {
            window.html_editor = CodeMirror.fromTextArea(document.getElementById("algorithm_html_textarea"), {
                mode: "xml",
                lineNumbers: false,
                theme: "the-matrix",
                autoRefresh: true,
                lineWrapping: true
            });
            window.html_editor.getWrapperElement().id = "algorithm_html_codemirror"
            window.javascript_editor = CodeMirror.fromTextArea(document.getElementById("algorithm_javascript_textarea"), {
                mode: "javascript",
                lineNumbers: false,
                theme: "the-matrix",
                autoRefresh: true,
                lineWrapping: true
            });
            window.javascript_editor.getWrapperElement().id = "algorithm_javascript_codemirror"
            window.html_editor.setValue('<!--Enter HTML here. -->');
            window.javascript_editor.setValue('//Enter JavaScript here.');
            load_tree()
        }
    </script>
</body>

</html>