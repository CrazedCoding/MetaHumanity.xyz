<!DOCTYPE html>
<html>

<head>
    <title>MetaHumanity.xyz</title>
    <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="icon" type="image/x-icon" href="assets/icon/favicon.ico">
    <link rel="stylesheet" href="codemirror/lib/codemirror.css">
    <link rel="stylesheet" href="codemirror/addon/dialog/dialog.css">
    <link rel="stylesheet" href="codemirror/addon/search/matchesonscrollbar.css">
    <link rel="stylesheet" href="codemirror/theme/the-matrix.css">

    <script type="text/javascript" src="codemirror/lib/codemirror.js"></script>
    <script type="text/javascript" src="codemirror/mode/javascript/javascript.js"></script>
    <script type="text/javascript" src="codemirror/mode/clike/clike.js"></script>
    <script type="text/javascript" src="codemirror/mode/xml/xml.js"></script>

    <script type="text/javascript" src="codemirror/addon/display/autorefresh.js"></script>
    <script type="text/javascript" src="codemirror/addon/dialog/dialog.js"></script>
    <script type="text/javascript" src="codemirror/addon/search/searchcursor.js"></script>
    <script type="text/javascript" src="codemirror/addon/search/search.js"></script>
    <script type="text/javascript" src="codemirror/addon/scroll/annotatescrollbar.js"></script>
    <script type="text/javascript" src="codemirror/addon/search/matchesonscrollbar.js"></script>
    <script type="text/javascript" src="codemirror/addon/search/jump-to-line.js"></script>

    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/style.css" />

    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="js/protobuf.js"></script>
</head>

<body>
    <div id="menu" class="topnav" style="display:none !important;">
        <a id="home_button" href="#home">MetaHumanity.xyz</a>
        <a id="browse_button" onclick="state.show_page(pages.BROWSE); ">Browse</a>
        <a id="edit_button" onclick="state.show_page(pages.EDIT); ">Edit</a>
        <a id="create_button" onclick="state.show_page(pages.CREATE); ">Create</a>
        <a id="profile_button" class="logged_in_content" style="display: none"
            onclick="state.show_page(pages.PROFILE);;">Profile</a>
        <a id="login_button" class="logged_out_content" onclick="state.show_page(pages.LOGIN);">Login</a>
        <a id="signup_button" class="logged_out_content" style="display: none"
            onclick="state.show_page(pages.SIGNUP);">Sign Up</a>
        <a id="logout_button" class="logged_in_content" style="display: none"
            onclick="state.show_page(pages.LOGOUT);">Log Out</a>
        <a href="javascript:void(0);" class="icon" onclick="state.toggle_nav()">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
        </a>
    </div>
    <div id="popovers" style="position: absolute; width: 100%; height: 100%; left: 0px; top: 0px; overflow: hidden;"></div>
    <div id="belownav" onclick="state.collapse_nav();">
    </div>
    <!-- <div fixed id="iframeDiv"
        style="position: fixed; top: 0px; left: 0px; right: 0px; bottom: 0px; height: 100%; width: 100%; z-index: -1;">
        <iframe sandbox="allow-scripts" allow="microphone" style="border: 0; margin: 0px !important;" src="canvas.html"
            id="mainIframe" class="webGLDiv"></iframe> -->

    <script>
        var iframe = null;

        //Protocol Buffer Types
        var Message = null;
        var User = null;
        var Captcha = null;

        const pages = {
            RECONNECT: "#reconnect",
            PROCESSING: "#processing",
            CLIENT_ERROR: "#client_error",
            SERVER_ERROR: "#server_error",
            RESET: "#reset",
            POLICY: "#policy",
            LOGOUT: "#logout",
            DELETE_ALGORITHM: "#delete_algorithm",
            REQUEST: "#request",
            HOME: "#home",
            BROWSE: "#browse",
            EDIT: "#edit",
            CREATE: "#create",
            DELETE_ACCOUNT: "#delete_account",
            PROFILE: "#profile",
            LOGIN: "#login",
            SIGNUP: "#signup",
        }

        function is_message_page(page_name) {
            return page_name == pages.CLIENT_ERROR ||
                page_name == pages.SERVER_ERROR ||
                page_name == pages.PROCESSING;
        }
        function Video() {
            this.data = null;
            this.extension = null;
            this.name = "";
        }

        function GlobalState() {
            this.logged_in = false;
            this.user_name = "";
            this.user_email = ""
            this.user_password = ""
            this.websocket = null;
            this.protocol = null;
            this.last_captcha = null;
            this.current_page = null;
            this.local_file = null;
            this.video = new Video();
            this.result = null;
            this.page_history = []
            this.first_connection = true;
            this.page_transitions = [];
            this.deleting_algorithm = false;
            this.deleting_account = false;
            this.pipeline = {
                contexts: [],
                programs: [],
                stages: []
            };
            this.context_codemirrors = [];
            this.program_codemirrors = [];
            this.stage_codemirrors = [];
            
            this.popover_counter = 0;
            this.popovers = [];
            this.first_connection = true;
        }
        var Auth, Image, Video, Sound, Person, Comment, MetaAlgorithm,
            Query, Catalog, Vote, OpenGLDimension, OpenGLUniform, OpenGLContext,
            OpenGLProgram, OpenGLStage, OpenGLPipeline, AlgorithmState,
            Algorithm, Custom, Error, Captcha, Message;

        var default_opengl_dimension, default_algorithm_context, default_algorithm_uniform,
            default_algorithm_program, default_algorithm_stage, default_create_algorithm;

        GlobalState.prototype.wait_for_proto_and_connect = function () {
            protobuf.load("proto/messages.proto", function (err, root) {
                if (err)
                    throw err;

                // Obtain a message type
                this.protocol = root;
                // Auth = this.protocol.lookupType("messages.Auth");
                // Video = this.protocol.lookupType("messages.Video");
                // Sound = this.protocol.lookupType("messages.Sound");
                // Person = this.protocol.lookupType("messages.Person");
                // Comment = this.protocol.lookupType("messages.Comment");
                // MetaAlgorithm = this.protocol.lookupType("messages.MetaAlgorithm");
                // Query = this.protocol.lookupType("messages.Query");
                // Catalog = this.protocol.lookupType("messages.Catalog");
                // Vote = this.protocol.lookupType("messages.Vote");
                OpenGLDimension = this.protocol.lookupType("messages.OpenGLDimension");
                OpenGLUniform = this.protocol.lookupType("messages.OpenGLUniform");
                // OpenGLContext = this.protocol.lookupType("messages.OpenGLContext");
                // OpenGLProgram = this.protocol.lookupType("messages.OpenGLProgram");
                OpenGLStage = this.protocol.lookupType("messages.OpenGLStage");
                // OpenGLPipeline = this.protocol.lookupType("messages.OpenGLPipeline");
                // AlgorithmState = this.protocol.lookupType("messages.AlgorithmState");
                // Algorithm = this.protocol.lookupType("messages.Algorithm");
                // Custom = this.protocol.lookupType("messages.Custom");
                // Error = this.protocol.lookupType("messages.Error");
                // Captcha = this.protocol.lookupType("messages.Captcha");
                Message = this.protocol.lookupType("messages.Message");

                this.show_page(pages.PROCESSING, "Connecting...", "Please be patient.", false);
                this.connect();
            }.bind(this));
        }
        GlobalState.prototype.reconnect = function () {
            this.show_page(pages.PROCESSING, "Reconnecting...", "Please be patient.", false);
            this.connect();
        }
        GlobalState.prototype.connect = function () {
            this.websocket = new WebSocket("wss://" + window.location.hostname);

            this.websocket.binaryType = "arraybuffer";
            this.websocket.onclose = function (event) {
                this.logged_in = false;
                //$(".connected_content").css("visibility", "hidden");
                this.show_logged_out_content();
                this.page_history = [];
                this.show_page(pages.LOGIN);
                this.show_page(pages.RECONNECT);
                this.show_page(pages.CLIENT_ERROR, "Connection closed. Code: " + event.code, "If you were logged in, you are now logged out.", true)
            }.bind(this)
            this.websocket.onmessage = function (event) {
                try {
                    var decoded = Message.decode(new Uint8Array(event.data));
                    this.handle_message(decoded);
                }
                catch (e) {
                    this.show_page(pages.CLIENT_ERROR, "Error! Could not decode server response", e + "", true);
                }
            }.bind(this);
            this.websocket.onopen = function () {
                if(this.first_connection)
                {
                   this.handle_navigation();
                   this.first_connection = false;
                }
                this.show_logged_out_content();
                this.hide_popovers();
                $("#belownav").fadeIn(1000.);
                $("#menu").fadeIn(1000.);
                if (window.location.hash == pages.RECONNECT)
                    window.location.hash = pages.HOME;
            }.bind(this);

            //$(".disconnected_content").css("visibility", "visible");
        }

        GlobalState.prototype.send = function (encoded, request_updates = false) {
            this.websocket.send(encoded.length);

            if (request_updates)
                this.websocket.send(1);
            else
                this.websocket.send(0);
            var fragment_size = 1024 * 512;
            for (var i = 0; i < encoded.length; i += fragment_size) {
                var start = i;
                var end = i + fragment_size;
                this.websocket.send(encoded.subarray(start, end));
            }
        }
        GlobalState.prototype.refresh_captchas = function () {
            if (this.websocket && this.websocket.readyState == WebSocket.OPEN)
                this.send(Message.encode({ type: Message.Type.CAPTCHA }).finish());
        }

        GlobalState.prototype.handle_message = function (proto) {
            console.log(proto);

            if (proto.type == Message.Type.LOGIN) {
                this.user_name = proto.auth.user;
                this.user_email = proto.auth.email;
                //this.user_password = proto.auth.password;
                this.hash = proto.auth.hash;
                this.logged_in = true;
                this.hide_popovers();
                this.show_page(pages.HOME);
            }
            if (proto.type == Message.Type.AUTH) {
                this.hash = proto.auth.hash;
            }
            else if (proto.type == Message.Type.SET_PASSWORD) {
                this.hide_popovers();
            }
            else if (proto.type == Message.Type.HALT) {
                this.show_page(pages.PROCESSING, proto.message, proto.details, false);
            }
            else if (proto.type == Message.Type.PROGRESS) {
                this.show_page(pages.PROCESSING, proto.message, proto.details);
            }
            else if (proto.type == Message.Type.DELETE_ACCOUNT) {
                this.hide_popovers();
                this.show_page(pages.PROCESSING, proto.message, proto.details, true, function (popover) {
                    state.websocket.close();
                    state.hide_popover(popover);
                });
            }
            else if (proto.type == Message.Type.REQUEST_PASSWORD_RESET) {
                this.show_page(pages.PROCESSING, proto.message, proto.details);
            }
            else if (proto.type == Message.Type.ERROR) {
                this.show_page(pages.SERVER_ERROR, proto.message, proto.details);
            }
            else if (proto.type == Message.Type.CAPTCHA) {


                var base_64_encoded = btoa(String.fromCharCode.apply(null, proto.captcha.image));

                this.unfiltered_captcha_image = document.createElement('img');
                this.unfiltered_captcha_image.onload = (function () {
                    var canvas = document.createElement('canvas');
                    canvas.width = this.unfiltered_captcha_image.width;
                    canvas.height = this.unfiltered_captcha_image.height;

                    var ctx = canvas.getContext("2d");

                    ctx.drawImage(this.unfiltered_captcha_image, 0, 0);
                    ctx.globalCompositeOperation = 'difference';
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    var image_data = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    var real_max = 0;
                    var real_min = 1E32;
                    for (var i = 0; i < image_data.data.length; i += 4) {
                        var max = Math.max(image_data.data[i], Math.max(image_data.data[i + 1], image_data.data[i + 2]));
                        var min = Math.min(image_data.data[i], Math.min(image_data.data[i + 1], image_data.data[i + 2]));
                        if (max < 32) {
                            image_data.data[i + 3] = 0; // alpha
                        }
                        else
                            real_min = Math.min(real_min, min);
                        real_max = Math.max(real_max, max);
                    }

                    for (var i = 0; i < image_data.data.length; i += 4) {
                        image_data.data[i] = (image_data.data[i] - real_min) / (real_max - real_min) * 256.;
                        image_data.data[i + 1] = (image_data.data[i + 1] - real_min) / (real_max - real_min) * 256.;
                        image_data.data[i + 2] = (image_data.data[i + 2] - real_min) / (real_max - real_min) * 256.;
                    }

                    ctx.putImageData(image_data, 0, 0);
                    var new_url = canvas.toDataURL();

                    $('#signup_captcha').attr('src', new_url);
                    $('#login_captcha').attr('src', new_url);
                    $('#reset_captcha').attr('src', new_url);
                    $('#request_captcha').attr('src', new_url);
                    $('#edit_captcha').attr('src', new_url);
                    $('#query_captcha').attr('src', new_url);
                    $('#delete_account_captcha').attr('src', new_url);

                    $('#signup_captcha_input').val("");
                    $('#login_captcha_input').val("");
                    $('#reset_captcha_input').val("");
                    $('#request_captcha_input').val("");
                    $('#edit_captcha_input').val("");
                    $('#query_captcha_input').val("");
                    $('#delete_account_captcha_input').val("");
                }).bind(this);
                this.unfiltered_captcha_image.src = `data:image/png;base64,${base_64_encoded}`

                this.last_captcha = proto.captcha;
            }
        }

        GlobalState.prototype.show_logged_out_content = function (new_page) {
            $.each($(".logged_in_content"), function () {
                if ($(this).is(":visible") && ($(new_page).has($(this)).length > 0 || $(this).parents().has("#menu").length > 0))
                    $(this).fadeOut(1000);
            });
            $.each($(".logged_out_content"), function () {
                if ($(this).is(":hidden") && ($(new_page).has($(this)).length > 0 || ($(this).parents().has("#menu").length > 0))) {
                    if ($($(this).parents()[0]).hasClass("topnav"))
                        $(this).attr("style", "");
                    else
                        $(this).fadeIn(1000).css("display", "block");
                }
            });
        }

        GlobalState.prototype.show_logged_in_content = function (new_page) {
            $.each($(".logged_in_content"), function () {
                //if($(this).is(":hidden") && 
                if (($(new_page).has($(this)).length > 0 || ($(this).parents().has("#menu").length > 0))) {
                    if ($($(this).parents()[0]).hasClass("topnav"))
                        $(this).attr("style", "");
                    else
                        $(this).fadeIn(1000).css("display", "block");
                }
            });
            $.each($(".logged_out_content"), function () {
                //if($(this).is(":visible") && 
                if (($(new_page).has($(this)).length > 0 || $(this).parents().has("#menu").length > 0))
                    $(this).fadeOut(1000);
            });
        }


        GlobalState.prototype.refresh_content = function (page) {
            switch (page) {
                case pages.RECONNECT:
                    if($("#menu").css("display") != "none")
                        $("#menu").fadeOut(1000);
                    $("#belownav").fadeOut(1000);
                    break;
                case pages.PROCESSING:
                    if($("#menu").css("display") != "none")
                        $("#menu").fadeOut(1000.);
                    $("#belownav").fadeOut(1000);
                    break;
                case pages.CLIENT_ERROR:
                    if($("#menu").css("display") != "none")
                        $("#menu").fadeOut(1000.);
                    $("#belownav").fadeOut(1000);
                    break;
                case pages.SERVER_ERROR:
                    if($("#menu").css("display") != "none")
                        $("#menu").fadeOut(1000.);
                    $("#belownav").fadeOut(1000);
                    break;
                case pages.RESET:
                    this.refresh_captchas();
                    if($("#menu").css("display") != "none")
                        $("#menu").fadeOut(1000.);

                    $("#home_button").removeClass("active")
                    $("#browse_button").removeClass("active")
                    $("#edit_button").removeClass("active")
                    $("#create_button").removeClass("active")
                    $("#profile_button").removeClass("active")
                    $("#login_button").removeClass("active")
                    $("#signup_button").removeClass("active")
                    $("#logout_button").removeClass("active")
                    break;
                case pages.POLICY:
                    $("#menu").fadeIn(1000);

                    $("#home_button").removeClass("active")
                    $("#browse_button").removeClass("active")
                    $("#edit_button").removeClass("active")
                    $("#create_button").removeClass("active")
                    $("#profile_button").removeClass("active")
                    $("#login_button").removeClass("active")
                    $("#signup_button").removeClass("active")
                    $("#logout_button").removeClass("active")
                    break;
                case pages.REQUEST:
                    this.refresh_captchas();
                    $("#menu").fadeIn(1000);

                    $("#home_button").removeClass("active")
                    $("#browse_button").removeClass("active")
                    $("#edit_button").removeClass("active")
                    $("#create_button").removeClass("active")
                    $("#profile_button").removeClass("active")
                    $("#login_button").removeClass("active")
                    $("#signup_button").removeClass("active")
                    $("#logout_button").removeClass("active")
                    break;
                case pages.HOME:
                    $("#menu").fadeIn(1000);

                    $("#home_button").addClass("active")
                    $("#browse_button").removeClass("active")
                    $("#edit_button").removeClass("active")
                    $("#create_button").removeClass("active")
                    $("#profile_button").removeClass("active")
                    $("#login_button").removeClass("active")
                    $("#signup_button").removeClass("active")
                    $("#logout_button").removeClass("active")
                    break;
                case pages.BROWSE:
                    $("#browse").fadeIn(1000);
                    $("#menu").fadeIn(1000);

                    $("#home_button").removeClass("active")
                    $("#browse_button").addClass("active")
                    $("#edit_button").removeClass("active")
                    $("#create_button").removeClass("active")
                    $("#profile_button").removeClass("active")
                    $("#login_button").removeClass("active")
                    $("#signup_button").removeClass("active")
                    $("#logout_button").removeClass("active")
                    break;
                case pages.EDIT:
                    this.refresh_captchas();
                    $("#menu").fadeIn(1000);

                    $("#home_button").removeClass("active")
                    $("#browse_button").removeClass("active")
                    $("#edit_button").addClass("active")
                    $("#create_button").removeClass("active")
                    $("#profile_button").removeClass("active")
                    $("#login_button").removeClass("active")
                    $("#signup_button").removeClass("active")
                    $("#logout_button").removeClass("active")
                    break;
                case pages.CREATE:
                    $("#create").fadeIn(1000);
                    $("#menu").fadeIn(1000);

                    $("#home_button").removeClass("active")
                    $("#browse_button").removeClass("active")
                    $("#edit_button").removeClass("active")
                    $("#create_button").addClass("active")
                    $("#profile_button").removeClass("active")
                    $("#login_button").removeClass("active")
                    $("#signup_button").removeClass("active")
                    $("#logout_button").removeClass("active")
                    break;
                case pages.DELETE_ACCOUNT:
                    this.refresh_captchas();
                    $("#menu").fadeIn(1000);
                    break;
                case pages.PROFILE:
                    $("#menu").fadeIn(1000);

                    $("#home_button").removeClass("active")
                    $("#browse_button").removeClass("active")
                    $("#edit_button").removeClass("active")
                    $("#create_button").removeClass("active")
                    $("#profile_button").addClass("active")
                    $("#login_button").removeClass("active")
                    $("#signup_button").removeClass("active")
                    $("#logout_button").removeClass("active")
                    break;
                case pages.LOGIN:
                    this.refresh_captchas();
                    $("#menu").fadeIn(1000);

                    $("#home_button").removeClass("active")
                    $("#browse_button").removeClass("active")
                    $("#edit_button").removeClass("active")
                    $("#create_button").removeClass("active")
                    $("#profile_button").removeClass("active")
                    $("#login_button").addClass("active")
                    $("#signup_button").removeClass("active")
                    $("#logout_button").removeClass("active")
                    break;
                case pages.SIGNUP:
                    this.refresh_captchas();
                    $("#menu").fadeIn(1000);

                    $("#home_button").removeClass("active")
                    $("#browse_button").removeClass("active")
                    $("#edit_button").removeClass("active")
                    $("#create_button").removeClass("active")
                    $("#profile_button").removeClass("active")
                    $("#login_button").removeClass("active")
                    $("#signup_button").addClass("active")
                    $("#logout_button").removeClass("active")
                    break;
                case pages.LOGOUT:
                    this.refresh_captchas();
                    $("#menu").fadeIn(1000);

                    $("#home_button").removeClass("active")
                    $("#browse_button").removeClass("active")
                    $("#edit_button").removeClass("active")
                    $("#create_button").removeClass("active")
                    $("#profile_button").removeClass("active")
                    $("#login_button").removeClass("active")
                    $("#signup_button").removeClass("active")
                    $("#logout_button").addClass("active")
                    break;
            }
        }

        GlobalState.prototype.change_title = function (page) {
            var message = "";
            switch (page) {
                case pages.RECONNECT:
                    message = "Reconnect";
                    break;
                case pages.PROCESSING:
                    message = "Processing";
                    break;
                case pages.RESET:
                    message = "Password Reset";
                    break;
                case pages.POLICY:
                    message = "Site Policies";
                    break;
                case pages.REQUEST:
                    message = "Request Password Reset";
                    break;
                case pages.CLIENT_ERROR:
                    message = "Client Error";
                    break;
                case pages.SERVER_ERROR:
                    message = "Server Error";
                    break;
                case pages.HOME:
                    message = "General Information";
                    break;
                case pages.BROWSE:
                    message = "Browse Algorithms";
                    break;
                case pages.EDIT:
                    message = "Edit Algorithm";
                    break;
                case pages.CREATE:
                    message = "Create Algorithm";
                    break;
                case pages.CREATE_QUERY:
                    message = "Create Visual Query";
                    break;
                case pages.DELETE_ACCOUNT:
                    message = "Delete Account";
                    break;
                case pages.PROFILE:
                    message = "Profile";
                    break;
                case pages.LOGIN:
                    message = "Log In";
                    break;
                case pages.SIGNUP:
                    message = "Sign Up";
                    break;
            }
            document.title = message;
        }

        GlobalState.prototype.coming_soon = function () {
            this.show_page(pages.PROCESSING, "This feature is coming soon!", "Please check again at a later date.", true);
        }

        GlobalState.prototype.get_ui_stages = function () {
            var ui_stages = [];
            for (var i = 0; i < this.pipeline.stages.length; i++) {
                var stage = this.pipeline.stages[i];
                var stage_identifier = stage.identifier;
                console.log(stage_identifier);
                var ui_stage = JSON.parse(JSON.stringify(stage));

                ui_stage.name = $("#" + stage_identifier + '_name').val();

                ui_stage.mesh_indices_eval = this.stage_codemirrors[i][0].getValue()
                ui_stage.mesh_vertices_eval = this.stage_codemirrors[i][1].getValue()

                ui_stages.push(ui_stage);
            }
            return ui_stages;
        }

        GlobalState.prototype.toggle_nav = function () {
            var x = document.getElementById("menu");
            if (x.className === "topnav") {
                x.className += " responsive";
            } else {
                x.className = "topnav";
            }
        }
        GlobalState.prototype.collapse_nav = function () {
            var x = document.getElementById("menu");
            x.className = "topnav";
        }
        GlobalState.prototype.show_page = function (page = pages.HOME, message = "", subtext = "", opt_out = true, completion_callback = function (popover) {state.hide_popover(popover); $("#belownav").fadeIn(1000.); $("#menu").fadeIn(1000.)}) {
            this.collapse_nav();
            console.log("SHOWING PAGE: " + page);

            if (page == pages.PROCESSING) {
                this.hide_popovers();
                $(function () {
                    page = 'popover'+this.popover_counter;
                    html = 
                        '<div class="row disconnected_content"\n' +
                        '    style="display:none; margin: 0px !important; z-index: 400; position:relative; text-align:center; border:none !important; height:100%; width:100%;  overflow-y: auto; background-color: rgba(0., 0., 0., 0.);"\n' +
                        '    id="'+page+'">\n' +
                        '    <div class="col-0 col-sm-0 col-md-1 col-lg-2">\n' +
                        '    </div>\n' +
                        '    <div class="col-12 col-sm-12 col-md-10 col-lg-8">\n' +
                        '        <div style="height: 20%;"></div>\n' +
                        '        <h1 style=" padding:5%; text-align:center; color:#f00; font-size: 24px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;"\n' +
                        '            class="blink-white">\n' +
                        '            <div id="popover_header'+this.popover_counter+'" style="text-align:center; color:#0f0; font-size: 24px !important;"\n' +
                        '                class="blink-white">\n' +
                        '                '+message+'\n' +
                        '            </div>\n' +
                        '            <br>\n' +
                        '            <label id="popover_message'+this.popover_counter+'" style="font-size: 14px !important;color: #fff;">\n' +
                        '                '+subtext+'\n' +
                        '            </label>\n' +
                        '            <br>\n' +
                        (opt_out ? ' <br>\n' +
                        '            <div style="text-align: center;">\n' +
                        '                <button type="button" class="opt_out btn btn-outline-success mx-auto"\n' +
                        '                    onclick="state.popover_callback('+this.popover_counter+')">OK</button>\n' +
                        '            </div>\n' : "" )+
                        '        </h1>\n' +
                        '    </div>\n' +
                        '    <div class="col-0 col-sm-0 col-md-1 col-lg-2">\n' +
                        '    </div>\n' +
                        '</div>\n';

                    var element = $(html);
                    $("#popovers").append(element);
                    element.popover({
                        container: 'body'
                    }).fadeIn(1000)

                    this.popover_counter++;
                    this.popovers.push({page : page,
                        message : message,
                        subtext : subtext,
                        opt_out : opt_out, 
                        completion_callback: completion_callback
                    });
                }.bind(this));
            }
            else if (page == pages.CLIENT_ERROR) {
                this.hide_popovers();
                $(function () {
                    page = 'popover'+this.popover_counter;
                    html =
                        '<div class="row disconnected_content"\n' +
                        '    style="display:none; margin: 0px !important; z-index: 400; position:relative; text-align:center; border:none !important; height:100%; width:100%;  overflow-y: auto; background-color: rgba(0., 0., 0., 0.);"\n' +
                        '    id="'+page+'">\n' +
                        '    <div class="col-0 col-sm-0 col-md-1 col-lg-2">\n' +
                        '    </div>\n' +
                        '    <div class="col-12 col-sm-12 col-md-10 col-lg-8">\n' +
                        '        <div style="height: 20%;"></div>\n' +
                        '        <h1 style=" padding:5%; text-align:center; color:#f00; font-size: 24px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;"\n' +
                        '            id="error_bubble" class="blink-white">\n' +
                        '            <div id="popover_header'+this.popover_counter+'" style="text-align:center; color:#f00; font-size: 24px !important;"\n' +
                        '                class="blink-white">\n' +
                        '                '+message+'\n' +
                        '            </div>\n' +
                        '            <br>\n' +
                        '            <label id="popover_message'+this.popover_counter+'" style="font-size: 14px !important;color: #fff;">'+subtext+'</label>\n' +
                        '            <br>\n' +
                        (opt_out ? ' <br>\n' +
                        '            <div style="text-align: center;">\n' +
                        '                <button type="button" class="btn btn-outline-danger mx-auto"\n' +
                        '                    onclick="state.popover_callback('+this.popover_counter+')">OK</button>\n' +
                        '            </div>\n' : "" )+
                        '        </h1>\n' +
                        '    </div>\n' +
                        '    <div class="col-0 col-sm-0 col-md-1 col-lg-2">\n' +
                        '    </div>\n' +
                        '</div>\n';

                    var element = $(html);
                    $("#popovers").append(element);
                    element.popover({
                        container: 'body'
                    }).fadeIn(1000)

                    this.popover_counter++;
                    this.popovers.push({page : page,
                        message : message,
                        subtext : subtext,
                        opt_out : opt_out, 
                        completion_callback: completion_callback
                    });
                }.bind(this));
            }
            else if (page == pages.SERVER_ERROR) {
                this.hide_popovers();
                $(function () {
                    page = 'popover'+this.popover_counter;
                    html =
                        '<div class="row disconnected_content"\n' +
                        '    style="display:none; margin: 0px !important; z-index: 400; position:relative; text-align:center; border:none !important; height:100%; width:100%;  overflow-y: auto; background-color: rgba(0., 0., 0., 0.);"\n' +
                        '    id="'+page+'">\n' +
                        '    <div class="col-0 col-sm-0 col-md-1 col-lg-2">\n' +
                        '    </div>\n' +
                        '    <div class="col-12 col-sm-12 col-md-10 col-lg-8">\n' +
                        '        <div style="height: 20%;"></div>\n' +
                        '        <h1 style=" padding:5%; text-align:center; color:#f00; font-size: 24px !important; width:auto; background-color: rgba(0,0,0,.75); border-radius: 12px; border: 1px solid #fff !important;"\n' +
                        '            id="error_bubble" class="blink-white">\n' +
                        '            <div id="popover_header'+this.popover_counter+'" style="text-align:center; color:#f00; font-size: 24px !important;"\n' +
                        '                class="blink-white">\n'+message+
                        '            </div>\n' +
                        '            <br>\n' +
                        '            <label id="popover_message" style="font-size: 14px !important;color: #fff;">'+subtext+'</label>\n' +
                        '            <br>\n' +
                        (opt_out ? ' <br>\n' +
                        '            <div style="text-align: center;">\n' +
                        '                <button type="button" class="btn btn-outline-danger mx-auto"\n' +
                        '                    onclick="state.popover_callback('+this.popover_counter+')">OK</button>\n' +
                        '            </div>\n' : "" )+
                        '        </h1>\n' +
                        '    </div>\n' +
                        '    <div class="col-0 col-sm-0 col-md-1 col-lg-2">\n' +
                        '    </div>\n' +
                        '</div>\n';

                    var element = $(html);
                    $("#popovers").append(element);
                    element.popover({
                        container: 'body'
                    }).fadeIn(1000)

                    this.popover_counter++;
                    this.popovers.push({page : page,
                        message : message,
                        subtext : subtext,
                        opt_out : opt_out, 
                        completion_callback: completion_callback
                    });
                }.bind(this));
            }
            else
                window.location.hash = page;
            this.refresh_content(page);
        }
        var on_resources_loaded = function () {
            console.log($)//Show me the money
            if (typeof $ == 'undefined' ||
                typeof $('[data-toggle="tooltip"]') == 'undefined' ||
                typeof $('[data-toggle="tooltip"]').tooltip == 'undefined' ||
                !protobuf)
                window.setTimeout(on_resources_loaded, 1000);
            else {
                $('[data-toggle="tooltip"]').tooltip();
                state.wait_for_proto_and_connect()
            }
        }

        GlobalState.prototype.popover_callback = function (identifier_index) {
            var page = "popover"+identifier_index;
            for(var i = 0; i < this.popovers.length; i++)
            {
                if(this.popovers[i].page == page)
                {
                    this.popovers[i].completion_callback(this.popovers[i]);
                }
            }
        }

        GlobalState.prototype.hide_popovers = function () {
            for(var i = 0; i < this.popovers.length; i++)
            {
                if(!this.popovers[i].opt_out)
                {
                    element = $("#"+this.popovers[i].page);
                    element.animate({
                        top: "-100%"
                    }, 1000, function() {
                        element.remove();
                    });
                    this.popovers.splice(i, 1)
                    i--;
                }
                else
                    break;
            }
        }

        GlobalState.prototype.hide_popover = function (popover) {
            for(var i = 0; i < this.popovers.length; i++)
            {
                if(this.popovers[i].page == popover.page)
                {
                    element = $("#"+this.popovers[i].page);
                    element.animate({
                        top: "-100%"
                    }, 1000, function() {
                        element.remove();
                    });
                    this.popovers.splice(i, 1)
                    i--;
                }
            }
        }

        GlobalState.prototype.handle_navigation = function () {
            var page = (window.location.hash ? window.location.hash.substring(1) : "home") + '.html';
            this.refresh_content(window.location.hash);
            $('#belownav').fadeOut(1000, function () {
                $.get(page, function (response) {
                    $('#belownav').html(response);
                    
                    if (this.logged_in)
                        this.show_logged_in_content(page)
                    else
                        this.show_logged_out_content(page);

                    $('#belownav').fadeIn(1000, function () {
                        this.refresh_content(window.location.hash);
                    }.bind(this));
                    this.change_title(window.location.hash)
                }.bind(this))
            }.bind(this))
        }
        state = new GlobalState();
        window.onload = function () {
            on_resources_loaded();
        }

        $(window).on('hashchange', function () {
            state.handle_navigation();
        });
    </script>
</body>

</html>